/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package som.mod.som.form;

import java.awt.Dimension;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.FocusEvent;
import java.awt.event.FocusListener;
import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.sql.Connection;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Calendar;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JOptionPane;
import javax.swing.JRadioButton;
import javax.swing.JSpinner;
import javax.swing.JTextField;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import sa.lib.SLibConsts;
import sa.lib.SLibTimeUtils;
import sa.lib.SLibUtils;
import sa.lib.db.SDbRegistry;
import sa.lib.gui.SGuiClient;
import sa.lib.gui.SGuiConsts;
import sa.lib.gui.SGuiItem;
import sa.lib.gui.SGuiParams;
import sa.lib.gui.SGuiUtils;
import sa.lib.gui.SGuiValidation;
import sa.lib.gui.bean.SBeanForm;
import som.gui.SGuiClientSessionCustom;
import som.gui.SGuiClientUtils;
import som.mod.SModConsts;
import som.mod.SModSysConsts;
import som.mod.cfg.db.SDbCompany;
import som.mod.som.db.SDbItem;
import som.mod.som.db.SDbProducer;
import som.mod.som.db.SDbTicket;
import som.mod.som.db.SDbTicketExwUpdate;
import som.mod.som.db.SDbTicketNote;
import som.mod.som.db.SSomConsts;
import som.mod.som.db.SSomUtils;

/**
 * Forma de captura de boletos de báscula.
 * @author Juan Barajas, Alfredo Pérez, Sergio Flores, Isabel Servín, Sergio Flores
 */
public class SFormTicket extends SBeanForm implements ActionListener, ItemListener, FocusListener, ChangeListener {

    private Connection moConnectionRevuelta;

    private SDbTicket moRegistry;
    private int mnCompanyId;
    private ArrayList<SGuiItem> maExternalWarehouses;
    private SDbItem moItem;
    private SDbProducer moProducer;
    private int mnSeasonId;
    private boolean mbIsPacking;
    private boolean mbIsLaboratory;
    private boolean mbIsFreightRequired;
    private boolean mbSaveSendCalled;
    private boolean mbSettingForm; // flag to prevent from dispatching item events when setting form fields
    private boolean mbProcessingProducer; // flag to prevent from dispatching item events when processing producer and related fields
    private boolean mbIsRevImport1;
    private boolean mbIsRevImport2;
    private String msScaleRevuelta;
    private String msCommentsArrival;
    private String msCommentsDeparture;

    private JButton jbSaveSend;

    /**
     * Creates new form SFormTicket
     * @param client GUI client.
     * @param title Form title.
     * @param formSubType Form subtype: 1) normal ticket: SLibConsts.UNDEFINED; 2) ticket to be tared: SModConsts.SX_TIC_TARE_PEND.
     */
    public SFormTicket(SGuiClient client, int formSubType, String title) {
        setFormSettings(client, SGuiConsts.BEAN_FORM_EDIT, SModConsts.S_TIC, formSubType, title);
        initComponents();
        initComponentsCustom();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        bgFreightType = new javax.swing.ButtonGroup();
        jPanel1 = new javax.swing.JPanel();
        jPanel2 = new javax.swing.JPanel();
        jPanel13 = new javax.swing.JPanel();
        jlScale = new javax.swing.JLabel();
        moKeyScale = new sa.lib.gui.bean.SBeanFieldKey();
        jtfScale = new javax.swing.JTextField();
        moBoolTared = new sa.lib.gui.bean.SBeanFieldBoolean();
        jPanel4 = new javax.swing.JPanel();
        jlTicket = new javax.swing.JLabel();
        moTextTicket = new sa.lib.gui.bean.SBeanFieldText();
        jlDummy = new javax.swing.JLabel();
        jbImportTicket = new javax.swing.JButton();
        jbCleanTicket = new javax.swing.JButton();
        jPanel10 = new javax.swing.JPanel();
        jlProducer = new javax.swing.JLabel();
        moKeyProducer = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel12 = new javax.swing.JPanel();
        jlItem = new javax.swing.JLabel();
        moKeyItem = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel21 = new javax.swing.JPanel();
        jlInputSource = new javax.swing.JLabel();
        moKeyInputSource = new sa.lib.gui.bean.SBeanFieldKey();
        jbSetDefaultInputSource = new javax.swing.JButton();
        jLabel6 = new javax.swing.JLabel();
        jlRegion = new javax.swing.JLabel();
        moKeyRegion = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel6 = new javax.swing.JPanel();
        jlPlates = new javax.swing.JLabel();
        moTextPlates = new sa.lib.gui.bean.SBeanFieldText();
        jlPlatesCage = new javax.swing.JLabel();
        moTextPlatesCage = new sa.lib.gui.bean.SBeanFieldText();
        jlPlatesCage1 = new javax.swing.JLabel();
        jPanel3 = new javax.swing.JPanel();
        jlDriver = new javax.swing.JLabel();
        moTextDriver = new sa.lib.gui.bean.SBeanFieldText();
        jPanel7 = new javax.swing.JPanel();
        jlWeightSource = new javax.swing.JLabel();
        moDecWeightSource = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlWeightSourceUnit = new javax.swing.JLabel();
        moBoolWeightSourceAvailable = new sa.lib.gui.bean.SBeanFieldBoolean();
        jlWeightSource1 = new javax.swing.JLabel();
        jPanel9 = new javax.swing.JPanel();
        jlWeightDestinyArrival = new javax.swing.JLabel();
        moDecWeightDestinyArrival = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlWeightDestinyArrivalUnit = new javax.swing.JLabel();
        jPanel15 = new javax.swing.JPanel();
        jlWeightDestinyDeparture = new javax.swing.JLabel();
        moDecWeightDestinyDeparture = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlWeightDestinyDepartureUnit = new javax.swing.JLabel();
        jbImportTicketTare = new javax.swing.JButton();
        jbCleanTicketTare = new javax.swing.JButton();
        jPanel8 = new javax.swing.JPanel();
        jlDatetimeArrival = new javax.swing.JLabel();
        moDatetimeArrival = new sa.lib.gui.bean.SBeanFieldDatetime();
        jlDatetimeArrival1 = new javax.swing.JLabel();
        jlScaleOperatorArrival = new javax.swing.JLabel();
        moTextScaleOperatorArrival = new sa.lib.gui.bean.SBeanFieldText();
        jtfOpCalendarMonth = new javax.swing.JTextField();
        jPanel11 = new javax.swing.JPanel();
        jlDatetimeDeparture = new javax.swing.JLabel();
        moDatetimeDeparture = new sa.lib.gui.bean.SBeanFieldDatetime();
        jlDatetimeDeparture1 = new javax.swing.JLabel();
        jlScaleOperatorDeparture = new javax.swing.JLabel();
        moTextScaleOperatorDeparture = new sa.lib.gui.bean.SBeanFieldText();
        jPanel5 = new javax.swing.JPanel();
        jlNote = new javax.swing.JLabel();
        moTextNote = new sa.lib.gui.bean.SBeanFieldText();
        jPanel17 = new javax.swing.JPanel();
        jlPacking = new javax.swing.JLabel();
        jlPackingFull = new javax.swing.JLabel();
        jlPacking1 = new javax.swing.JLabel();
        jlPacking2 = new javax.swing.JLabel();
        jlPacking3 = new javax.swing.JLabel();
        jlPackingEmpty = new javax.swing.JLabel();
        jPanel16 = new javax.swing.JPanel();
        jlPackingQuantityArrival = new javax.swing.JLabel();
        moDecPackingFullQuantityArrival = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlPackingFullQuantityArrivalUnits = new javax.swing.JLabel();
        jbEditPackingFullQuantityArrival = new javax.swing.JButton();
        jlPackingQuantityArrival2 = new javax.swing.JLabel();
        moDecPackingEmptyQuantityArrival = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlPackingEmptyQuantityArrivalUnits = new javax.swing.JLabel();
        jbEditPackingEmptyQuantityArrival = new javax.swing.JButton();
        jlPackingQuantityArrival4 = new javax.swing.JLabel();
        jlPackingWeight = new javax.swing.JLabel();
        moDecPackingWeight = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlPackingWeightUnit = new javax.swing.JLabel();
        jPanel18 = new javax.swing.JPanel();
        jlPackingQuantityDeparture = new javax.swing.JLabel();
        moDecPackingFullQuantityDeparture = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlPackingFullQuantityDepartureUnits = new javax.swing.JLabel();
        jlPackingQuantityDeparture1 = new javax.swing.JLabel();
        jlPackingQuantityDeparture2 = new javax.swing.JLabel();
        moDecPackingEmptyQuantityDeparture = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlPackingEmptyQuantityDepartureUnits = new javax.swing.JLabel();
        jlPackingQuantityDeparture3 = new javax.swing.JLabel();
        jlPackingQuantityDeparture4 = new javax.swing.JLabel();
        jlWeightAverage = new javax.swing.JLabel();
        moDecWeightAverage = new sa.lib.gui.bean.SBeanFieldDecimal();
        jlWeightAverageUnits = new javax.swing.JLabel();
        jlWeightAverage1 = new javax.swing.JLabel();
        jPanel14 = new javax.swing.JPanel();
        jlTicketOrigin = new javax.swing.JLabel();
        moKeyTicketOrigin = new sa.lib.gui.bean.SBeanFieldKey();
        jlTicketOrigin1 = new javax.swing.JLabel();
        jlExwFacilityOrigin = new javax.swing.JLabel();
        moKeyExwFacilityOrigin = new sa.lib.gui.bean.SBeanFieldKey();
        jlExwFacilityOrigin1 = new javax.swing.JLabel();
        jlExwUpdateNote = new javax.swing.JLabel();
        jPanel22 = new javax.swing.JPanel();
        jlTicketDestination = new javax.swing.JLabel();
        moKeyTicketDestination = new sa.lib.gui.bean.SBeanFieldKey();
        jlTicketDestination1 = new javax.swing.JLabel();
        jlExwFacilityDestination = new javax.swing.JLabel();
        moKeyExwFacilityDestination = new sa.lib.gui.bean.SBeanFieldKey();
        jlExwFacilityDestination1 = new javax.swing.JLabel();
        moTextExwUpdateNote = new sa.lib.gui.bean.SBeanFieldText();
        jPanel19 = new javax.swing.JPanel();
        jlFreightControl = new javax.swing.JLabel();
        moRadFreightFreight = new sa.lib.gui.bean.SBeanFieldRadio();
        jlFreightControlF1 = new javax.swing.JLabel();
        jlFreightOrigin = new javax.swing.JLabel();
        moKeyFreightOrigin = new sa.lib.gui.bean.SBeanFieldKey();
        jPanel20 = new javax.swing.JPanel();
        jlFreightControl1 = new javax.swing.JLabel();
        moRadFreightDependent = new sa.lib.gui.bean.SBeanFieldRadio();
        jlFreightControlD1 = new javax.swing.JLabel();
        jlFreightTicket = new javax.swing.JLabel();
        moKeyFreightTicket = new sa.lib.gui.bean.SBeanFieldKey();

        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosed(java.awt.event.WindowEvent evt) {
                formWindowClosed(evt);
            }
        });

        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder("Datos del registro:"));
        jPanel1.setLayout(new java.awt.BorderLayout());

        jPanel2.setLayout(new java.awt.GridLayout(20, 1, 0, 5));

        jPanel13.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlScale.setForeground(new java.awt.Color(51, 51, 255));
        jlScale.setText("Báscula:*");
        jlScale.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel13.add(jlScale);

        moKeyScale.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel13.add(moKeyScale);

        jtfScale.setEditable(false);
        jtfScale.setText("TEXT");
        jtfScale.setFocusable(false);
        jtfScale.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel13.add(jtfScale);

        moBoolTared.setText("Boleto tarado");
        moBoolTared.setEditable(false);
        moBoolTared.setPreferredSize(new java.awt.Dimension(115, 23));
        jPanel13.add(moBoolTared);

        jPanel2.add(jPanel13);

        jPanel4.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlTicket.setText("Boleto:*");
        jlTicket.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel4.add(jlTicket);

        moTextTicket.setText("TEXT");
        jPanel4.add(moTextTicket);

        jlDummy.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel4.add(jlDummy);

        jbImportTicket.setText("Importar de Revuelta");
        jbImportTicket.setToolTipText("Importar de Revuelta (primer pesada)");
        jbImportTicket.setPreferredSize(new java.awt.Dimension(165, 23));
        jPanel4.add(jbImportTicket);

        jbCleanTicket.setText("Limpiar");
        jbCleanTicket.setToolTipText("Limpiar datos primer pesada");
        jbCleanTicket.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel4.add(jbCleanTicket);

        jPanel2.add(jPanel4);

        jPanel10.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlProducer.setText("Proveedor:*");
        jlProducer.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel10.add(jlProducer);

        moKeyProducer.setPreferredSize(new java.awt.Dimension(600, 23));
        jPanel10.add(moKeyProducer);

        jPanel2.add(jPanel10);

        jPanel12.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlItem.setText("Ítem:*");
        jlItem.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel12.add(jlItem);

        moKeyItem.setPreferredSize(new java.awt.Dimension(600, 23));
        jPanel12.add(moKeyItem);

        jPanel2.add(jPanel12);

        jPanel21.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlInputSource.setText("Origen del insumo:*");
        jlInputSource.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel21.add(jlInputSource);

        moKeyInputSource.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel21.add(moKeyInputSource);

        jbSetDefaultInputSource.setIcon(new javax.swing.ImageIcon(getClass().getResource("/som/gui/img/icon_std_wizard.gif"))); // NOI18N
        jbSetDefaultInputSource.setToolTipText("Seleccionar origen insumo del proveedor");
        jbSetDefaultInputSource.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel21.add(jbSetDefaultInputSource);

        jLabel6.setPreferredSize(new java.awt.Dimension(5, 23));
        jPanel21.add(jLabel6);

        jlRegion.setText("Región:*");
        jlRegion.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel21.add(jlRegion);

        moKeyRegion.setPreferredSize(new java.awt.Dimension(202, 23));
        jPanel21.add(moKeyRegion);

        jPanel2.add(jPanel21);

        jPanel6.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPlates.setText("Placas del vehículo:*");
        jlPlates.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel6.add(jlPlates);

        moTextPlates.setText("TEXT");
        jPanel6.add(moTextPlates);

        jlPlatesCage.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jlPlatesCage.setText("Placas caja:");
        jlPlatesCage.setPreferredSize(new java.awt.Dimension(90, 23));
        jPanel6.add(jlPlatesCage);

        moTextPlatesCage.setText("TEXT");
        jPanel6.add(moTextPlatesCage);

        jlPlatesCage1.setForeground(java.awt.SystemColor.textInactiveText);
        jlPlatesCage1.setText("(Placas de la caja o remolque del vehículo.)");
        jlPlatesCage1.setPreferredSize(new java.awt.Dimension(295, 23));
        jPanel6.add(jlPlatesCage1);

        jPanel2.add(jPanel6);

        jPanel3.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDriver.setText("Chofer del vehículo:*");
        jlDriver.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel3.add(jlDriver);

        moTextDriver.setText("TEXT");
        moTextDriver.setPreferredSize(new java.awt.Dimension(300, 23));
        jPanel3.add(moTextDriver);

        jPanel2.add(jPanel3);

        jPanel7.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlWeightSource.setText("Peso origen:*");
        jlWeightSource.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel7.add(jlWeightSource);
        jPanel7.add(moDecWeightSource);

        jlWeightSourceUnit.setText("UNIT");
        jlWeightSourceUnit.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlWeightSourceUnit.setPreferredSize(new java.awt.Dimension(35, 23));
        jPanel7.add(jlWeightSourceUnit);

        moBoolWeightSourceAvailable.setText("Peso origen disponible");
        moBoolWeightSourceAvailable.setPreferredSize(new java.awt.Dimension(155, 23));
        jPanel7.add(moBoolWeightSourceAvailable);

        jlWeightSource1.setForeground(java.awt.SystemColor.textInactiveText);
        jlWeightSource1.setText("(Tara manifestada por el proveedor desde el origen.)");
        jlWeightSource1.setPreferredSize(new java.awt.Dimension(295, 23));
        jPanel7.add(jlWeightSource1);

        jPanel2.add(jPanel7);

        jPanel9.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlWeightDestinyArrival.setText("Peso en entrada:*");
        jlWeightDestinyArrival.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel9.add(jlWeightDestinyArrival);
        jPanel9.add(moDecWeightDestinyArrival);

        jlWeightDestinyArrivalUnit.setText("UNIT");
        jlWeightDestinyArrivalUnit.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlWeightDestinyArrivalUnit.setPreferredSize(new java.awt.Dimension(35, 23));
        jPanel9.add(jlWeightDestinyArrivalUnit);

        jPanel2.add(jPanel9);

        jPanel15.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlWeightDestinyDeparture.setText("Peso en salida:*");
        jlWeightDestinyDeparture.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel15.add(jlWeightDestinyDeparture);
        jPanel15.add(moDecWeightDestinyDeparture);

        jlWeightDestinyDepartureUnit.setText("UNIT");
        jlWeightDestinyDepartureUnit.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlWeightDestinyDepartureUnit.setPreferredSize(new java.awt.Dimension(35, 23));
        jPanel15.add(jlWeightDestinyDepartureUnit);

        jbImportTicketTare.setText("Importar de Revuelta");
        jbImportTicketTare.setToolTipText("Importar de Revuelta (segunda pesada)");
        jbImportTicketTare.setPreferredSize(new java.awt.Dimension(165, 23));
        jPanel15.add(jbImportTicketTare);

        jbCleanTicketTare.setText("Limpiar");
        jbCleanTicketTare.setToolTipText("Limpiar datos segunda pesada");
        jbCleanTicketTare.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel15.add(jbCleanTicketTare);

        jPanel2.add(jPanel15);

        jPanel8.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDatetimeArrival.setText("Fecha-hora de entrada:*");
        jlDatetimeArrival.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel8.add(jlDatetimeArrival);
        jPanel8.add(moDatetimeArrival);

        jlDatetimeArrival1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel8.add(jlDatetimeArrival1);

        jlScaleOperatorArrival.setText("Operador báscula en entrada:");
        jlScaleOperatorArrival.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel8.add(jlScaleOperatorArrival);

        moTextScaleOperatorArrival.setEditable(false);
        moTextScaleOperatorArrival.setText("TEXT");
        moTextScaleOperatorArrival.setPreferredSize(new java.awt.Dimension(227, 23));
        jPanel8.add(moTextScaleOperatorArrival);

        jtfOpCalendarMonth.setEditable(false);
        jtfOpCalendarMonth.setHorizontalAlignment(javax.swing.JTextField.CENTER);
        jtfOpCalendarMonth.setText("2001-01");
        jtfOpCalendarMonth.setToolTipText("Mes operativo");
        jtfOpCalendarMonth.setFocusable(false);
        jtfOpCalendarMonth.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel8.add(jtfOpCalendarMonth);

        jPanel2.add(jPanel8);

        jPanel11.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlDatetimeDeparture.setText("Fecha-hora de salida:*");
        jlDatetimeDeparture.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel11.add(jlDatetimeDeparture);
        jPanel11.add(moDatetimeDeparture);

        jlDatetimeDeparture1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel11.add(jlDatetimeDeparture1);

        jlScaleOperatorDeparture.setText("Operador báscula en salida:");
        jlScaleOperatorDeparture.setPreferredSize(new java.awt.Dimension(175, 23));
        jPanel11.add(jlScaleOperatorDeparture);

        moTextScaleOperatorDeparture.setEditable(false);
        moTextScaleOperatorDeparture.setText("TEXT");
        moTextScaleOperatorDeparture.setPreferredSize(new java.awt.Dimension(227, 23));
        jPanel11.add(moTextScaleOperatorDeparture);

        jPanel2.add(jPanel11);

        jPanel5.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlNote.setText("Observaciones en entrada:");
        jlNote.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel5.add(jlNote);

        moTextNote.setText("TEXT");
        moTextNote.setPreferredSize(new java.awt.Dimension(600, 23));
        jPanel5.add(moTextNote);

        jPanel2.add(jPanel5);

        jPanel17.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPacking.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel17.add(jlPacking);

        jlPackingFull.setText("Envases llenos:");
        jlPackingFull.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel17.add(jlPackingFull);

        jlPacking1.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel17.add(jlPacking1);

        jlPacking2.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel17.add(jlPacking2);

        jlPacking3.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel17.add(jlPacking3);

        jlPackingEmpty.setText("Envases vacíos:");
        jlPackingEmpty.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel17.add(jlPackingEmpty);

        jPanel2.add(jPanel17);

        jPanel16.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPackingQuantityArrival.setText("Núm. envases en entrada:");
        jlPackingQuantityArrival.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel16.add(jlPackingQuantityArrival);
        jPanel16.add(moDecPackingFullQuantityArrival);

        jlPackingFullQuantityArrivalUnits.setText("PAQ");
        jlPackingFullQuantityArrivalUnits.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlPackingFullQuantityArrivalUnits.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel16.add(jlPackingFullQuantityArrivalUnits);

        jbEditPackingFullQuantityArrival.setIcon(new javax.swing.ImageIcon(getClass().getResource("/som/gui/img/icon_std_edit.gif"))); // NOI18N
        jbEditPackingFullQuantityArrival.setToolTipText("Modificar cantidad empaque lleno");
        jbEditPackingFullQuantityArrival.setMargin(new java.awt.Insets(0, 0, 0, 0));
        jbEditPackingFullQuantityArrival.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel16.add(jbEditPackingFullQuantityArrival);

        jlPackingQuantityArrival2.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel16.add(jlPackingQuantityArrival2);
        jPanel16.add(moDecPackingEmptyQuantityArrival);

        jlPackingEmptyQuantityArrivalUnits.setText("PAQ");
        jlPackingEmptyQuantityArrivalUnits.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlPackingEmptyQuantityArrivalUnits.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel16.add(jlPackingEmptyQuantityArrivalUnits);

        jbEditPackingEmptyQuantityArrival.setIcon(new javax.swing.ImageIcon(getClass().getResource("/som/gui/img/icon_std_edit.gif"))); // NOI18N
        jbEditPackingEmptyQuantityArrival.setToolTipText("Modificar cantidad empaque vacío");
        jbEditPackingEmptyQuantityArrival.setMargin(new java.awt.Insets(0, 0, 0, 0));
        jbEditPackingEmptyQuantityArrival.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel16.add(jbEditPackingEmptyQuantityArrival);

        jlPackingQuantityArrival4.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel16.add(jlPackingQuantityArrival4);

        jlPackingWeight.setText("Peso por envase:");
        jlPackingWeight.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel16.add(jlPackingWeight);

        moDecPackingWeight.setEditable(false);
        jPanel16.add(moDecPackingWeight);

        jlPackingWeightUnit.setText("UNIT");
        jlPackingWeightUnit.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlPackingWeightUnit.setPreferredSize(new java.awt.Dimension(35, 23));
        jPanel16.add(jlPackingWeightUnit);

        jPanel2.add(jPanel16);

        jPanel18.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlPackingQuantityDeparture.setText("Núm. envases en salida:");
        jlPackingQuantityDeparture.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel18.add(jlPackingQuantityDeparture);
        jPanel18.add(moDecPackingFullQuantityDeparture);

        jlPackingFullQuantityDepartureUnits.setText("PAQ");
        jlPackingFullQuantityDepartureUnits.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlPackingFullQuantityDepartureUnits.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel18.add(jlPackingFullQuantityDepartureUnits);

        jlPackingQuantityDeparture1.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel18.add(jlPackingQuantityDeparture1);

        jlPackingQuantityDeparture2.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel18.add(jlPackingQuantityDeparture2);
        jPanel18.add(moDecPackingEmptyQuantityDeparture);

        jlPackingEmptyQuantityDepartureUnits.setText("PAQ");
        jlPackingEmptyQuantityDepartureUnits.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlPackingEmptyQuantityDepartureUnits.setPreferredSize(new java.awt.Dimension(50, 23));
        jPanel18.add(jlPackingEmptyQuantityDepartureUnits);

        jlPackingQuantityDeparture3.setPreferredSize(new java.awt.Dimension(23, 23));
        jPanel18.add(jlPackingQuantityDeparture3);

        jlPackingQuantityDeparture4.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel18.add(jlPackingQuantityDeparture4);

        jlWeightAverage.setText("Peso promedio:");
        jlWeightAverage.setPreferredSize(new java.awt.Dimension(100, 23));
        jPanel18.add(jlWeightAverage);

        moDecWeightAverage.setEditable(false);
        jPanel18.add(moDecWeightAverage);

        jlWeightAverageUnits.setText("PAQ / UNIT");
        jlWeightAverageUnits.setBorder(javax.swing.BorderFactory.createLineBorder(java.awt.SystemColor.activeCaptionBorder));
        jlWeightAverageUnits.setPreferredSize(new java.awt.Dimension(75, 23));
        jPanel18.add(jlWeightAverageUnits);

        jlWeightAverage1.setForeground(java.awt.SystemColor.textInactiveText);
        jlWeightAverage1.setText("(De envases llenos.)");
        jlWeightAverage1.setPreferredSize(new java.awt.Dimension(125, 23));
        jPanel18.add(jlWeightAverage1);

        jPanel2.add(jPanel18);

        jPanel14.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlTicketOrigin.setText("Procedencia del boleto:*");
        jlTicketOrigin.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel14.add(jlTicketOrigin);

        moKeyTicketOrigin.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel14.add(moKeyTicketOrigin);

        jlTicketOrigin1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel14.add(jlTicketOrigin1);

        jlExwFacilityOrigin.setText("Almacén de procedencia:*");
        jlExwFacilityOrigin.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel14.add(jlExwFacilityOrigin);

        moKeyExwFacilityOrigin.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel14.add(moKeyExwFacilityOrigin);

        jlExwFacilityOrigin1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel14.add(jlExwFacilityOrigin1);

        jlExwUpdateNote.setText("Notas de la modificación:");
        jlExwUpdateNote.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel14.add(jlExwUpdateNote);

        jPanel2.add(jPanel14);

        jPanel22.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlTicketDestination.setText("Destino del boleto:*");
        jlTicketDestination.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel22.add(jlTicketDestination);

        moKeyTicketDestination.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel22.add(moKeyTicketDestination);

        jlTicketDestination1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel22.add(jlTicketDestination1);

        jlExwFacilityDestination.setText("Almacén de destino:*");
        jlExwFacilityDestination.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel22.add(jlExwFacilityDestination);

        moKeyExwFacilityDestination.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel22.add(moKeyExwFacilityDestination);

        jlExwFacilityDestination1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel22.add(jlExwFacilityDestination1);

        moTextExwUpdateNote.setText("TEXT");
        moTextExwUpdateNote.setPreferredSize(new java.awt.Dimension(225, 23));
        jPanel22.add(moTextExwUpdateNote);

        jPanel2.add(jPanel22);

        jPanel19.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlFreightControl.setText("Control de fletes:");
        jlFreightControl.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel19.add(jlFreightControl);

        bgFreightType.add(moRadFreightFreight);
        moRadFreightFreight.setText("El boleto implica un flete");
        moRadFreightFreight.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel19.add(moRadFreightFreight);

        jlFreightControlF1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel19.add(jlFreightControlF1);

        jlFreightOrigin.setText("Origen del flete:*");
        jlFreightOrigin.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel19.add(jlFreightOrigin);

        moKeyFreightOrigin.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel19.add(moKeyFreightOrigin);

        jPanel2.add(jPanel19);

        jPanel20.setLayout(new java.awt.FlowLayout(java.awt.FlowLayout.LEFT, 5, 0));

        jlFreightControl1.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel20.add(jlFreightControl1);

        bgFreightType.add(moRadFreightDependent);
        moRadFreightDependent.setText("El flete depende de otro boleto");
        moRadFreightDependent.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel20.add(moRadFreightDependent);

        jlFreightControlD1.setPreferredSize(new java.awt.Dimension(25, 23));
        jPanel20.add(jlFreightControlD1);

        jlFreightTicket.setText("Boleto del flete:*");
        jlFreightTicket.setPreferredSize(new java.awt.Dimension(150, 23));
        jPanel20.add(jlFreightTicket);

        moKeyFreightTicket.setPreferredSize(new java.awt.Dimension(200, 23));
        jPanel20.add(moKeyFreightTicket);

        jPanel2.add(jPanel20);

        jPanel1.add(jPanel2, java.awt.BorderLayout.NORTH);

        getContentPane().add(jPanel1, java.awt.BorderLayout.CENTER);
    }// </editor-fold>//GEN-END:initComponents

    private void formWindowClosed(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_formWindowClosed
        closeConnectionRevuelta();
    }//GEN-LAST:event_formWindowClosed

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.ButtonGroup bgFreightType;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JPanel jPanel10;
    private javax.swing.JPanel jPanel11;
    private javax.swing.JPanel jPanel12;
    private javax.swing.JPanel jPanel13;
    private javax.swing.JPanel jPanel14;
    private javax.swing.JPanel jPanel15;
    private javax.swing.JPanel jPanel16;
    private javax.swing.JPanel jPanel17;
    private javax.swing.JPanel jPanel18;
    private javax.swing.JPanel jPanel19;
    private javax.swing.JPanel jPanel2;
    private javax.swing.JPanel jPanel20;
    private javax.swing.JPanel jPanel21;
    private javax.swing.JPanel jPanel22;
    private javax.swing.JPanel jPanel3;
    private javax.swing.JPanel jPanel4;
    private javax.swing.JPanel jPanel5;
    private javax.swing.JPanel jPanel6;
    private javax.swing.JPanel jPanel7;
    private javax.swing.JPanel jPanel8;
    private javax.swing.JPanel jPanel9;
    private javax.swing.JButton jbCleanTicket;
    private javax.swing.JButton jbCleanTicketTare;
    private javax.swing.JButton jbEditPackingEmptyQuantityArrival;
    private javax.swing.JButton jbEditPackingFullQuantityArrival;
    private javax.swing.JButton jbImportTicket;
    private javax.swing.JButton jbImportTicketTare;
    private javax.swing.JButton jbSetDefaultInputSource;
    private javax.swing.JLabel jlDatetimeArrival;
    private javax.swing.JLabel jlDatetimeArrival1;
    private javax.swing.JLabel jlDatetimeDeparture;
    private javax.swing.JLabel jlDatetimeDeparture1;
    private javax.swing.JLabel jlDriver;
    private javax.swing.JLabel jlDummy;
    private javax.swing.JLabel jlExwFacilityDestination;
    private javax.swing.JLabel jlExwFacilityDestination1;
    private javax.swing.JLabel jlExwFacilityOrigin;
    private javax.swing.JLabel jlExwFacilityOrigin1;
    private javax.swing.JLabel jlExwUpdateNote;
    private javax.swing.JLabel jlFreightControl;
    private javax.swing.JLabel jlFreightControl1;
    private javax.swing.JLabel jlFreightControlD1;
    private javax.swing.JLabel jlFreightControlF1;
    private javax.swing.JLabel jlFreightOrigin;
    private javax.swing.JLabel jlFreightTicket;
    private javax.swing.JLabel jlInputSource;
    private javax.swing.JLabel jlItem;
    private javax.swing.JLabel jlNote;
    private javax.swing.JLabel jlPacking;
    private javax.swing.JLabel jlPacking1;
    private javax.swing.JLabel jlPacking2;
    private javax.swing.JLabel jlPacking3;
    private javax.swing.JLabel jlPackingEmpty;
    private javax.swing.JLabel jlPackingEmptyQuantityArrivalUnits;
    private javax.swing.JLabel jlPackingEmptyQuantityDepartureUnits;
    private javax.swing.JLabel jlPackingFull;
    private javax.swing.JLabel jlPackingFullQuantityArrivalUnits;
    private javax.swing.JLabel jlPackingFullQuantityDepartureUnits;
    private javax.swing.JLabel jlPackingQuantityArrival;
    private javax.swing.JLabel jlPackingQuantityArrival2;
    private javax.swing.JLabel jlPackingQuantityArrival4;
    private javax.swing.JLabel jlPackingQuantityDeparture;
    private javax.swing.JLabel jlPackingQuantityDeparture1;
    private javax.swing.JLabel jlPackingQuantityDeparture2;
    private javax.swing.JLabel jlPackingQuantityDeparture3;
    private javax.swing.JLabel jlPackingQuantityDeparture4;
    private javax.swing.JLabel jlPackingWeight;
    private javax.swing.JLabel jlPackingWeightUnit;
    private javax.swing.JLabel jlPlates;
    private javax.swing.JLabel jlPlatesCage;
    private javax.swing.JLabel jlPlatesCage1;
    private javax.swing.JLabel jlProducer;
    private javax.swing.JLabel jlRegion;
    private javax.swing.JLabel jlScale;
    private javax.swing.JLabel jlScaleOperatorArrival;
    private javax.swing.JLabel jlScaleOperatorDeparture;
    private javax.swing.JLabel jlTicket;
    private javax.swing.JLabel jlTicketDestination;
    private javax.swing.JLabel jlTicketDestination1;
    private javax.swing.JLabel jlTicketOrigin;
    private javax.swing.JLabel jlTicketOrigin1;
    private javax.swing.JLabel jlWeightAverage;
    private javax.swing.JLabel jlWeightAverage1;
    private javax.swing.JLabel jlWeightAverageUnits;
    private javax.swing.JLabel jlWeightDestinyArrival;
    private javax.swing.JLabel jlWeightDestinyArrivalUnit;
    private javax.swing.JLabel jlWeightDestinyDeparture;
    private javax.swing.JLabel jlWeightDestinyDepartureUnit;
    private javax.swing.JLabel jlWeightSource;
    private javax.swing.JLabel jlWeightSource1;
    private javax.swing.JLabel jlWeightSourceUnit;
    private javax.swing.JTextField jtfOpCalendarMonth;
    private javax.swing.JTextField jtfScale;
    private sa.lib.gui.bean.SBeanFieldBoolean moBoolTared;
    private sa.lib.gui.bean.SBeanFieldBoolean moBoolWeightSourceAvailable;
    private sa.lib.gui.bean.SBeanFieldDatetime moDatetimeArrival;
    private sa.lib.gui.bean.SBeanFieldDatetime moDatetimeDeparture;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecPackingEmptyQuantityArrival;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecPackingEmptyQuantityDeparture;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecPackingFullQuantityArrival;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecPackingFullQuantityDeparture;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecPackingWeight;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecWeightAverage;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecWeightDestinyArrival;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecWeightDestinyDeparture;
    private sa.lib.gui.bean.SBeanFieldDecimal moDecWeightSource;
    private sa.lib.gui.bean.SBeanFieldKey moKeyExwFacilityDestination;
    private sa.lib.gui.bean.SBeanFieldKey moKeyExwFacilityOrigin;
    private sa.lib.gui.bean.SBeanFieldKey moKeyFreightOrigin;
    private sa.lib.gui.bean.SBeanFieldKey moKeyFreightTicket;
    private sa.lib.gui.bean.SBeanFieldKey moKeyInputSource;
    private sa.lib.gui.bean.SBeanFieldKey moKeyItem;
    private sa.lib.gui.bean.SBeanFieldKey moKeyProducer;
    private sa.lib.gui.bean.SBeanFieldKey moKeyRegion;
    private sa.lib.gui.bean.SBeanFieldKey moKeyScale;
    private sa.lib.gui.bean.SBeanFieldKey moKeyTicketDestination;
    private sa.lib.gui.bean.SBeanFieldKey moKeyTicketOrigin;
    private sa.lib.gui.bean.SBeanFieldRadio moRadFreightDependent;
    private sa.lib.gui.bean.SBeanFieldRadio moRadFreightFreight;
    private sa.lib.gui.bean.SBeanFieldText moTextDriver;
    private sa.lib.gui.bean.SBeanFieldText moTextExwUpdateNote;
    private sa.lib.gui.bean.SBeanFieldText moTextNote;
    private sa.lib.gui.bean.SBeanFieldText moTextPlates;
    private sa.lib.gui.bean.SBeanFieldText moTextPlatesCage;
    private sa.lib.gui.bean.SBeanFieldText moTextScaleOperatorArrival;
    private sa.lib.gui.bean.SBeanFieldText moTextScaleOperatorDeparture;
    private sa.lib.gui.bean.SBeanFieldText moTextTicket;
    // End of variables declaration//GEN-END:variables

    @SuppressWarnings("unchecked")
    private void initComponentsCustom() {
        SGuiUtils.setWindowBounds(this, 1040, 650);
        
        mnCompanyId = ((SDbCompany) (((SGuiClientSessionCustom) miClient.getSession().getSessionCustom())).getCompany()).getFkProducerReceiver_n();
        
        jbSaveSend = new JButton("Guardar y enviar al estado siguiente");
        jbSaveSend.setPreferredSize(new Dimension(250, 23));
        jbSaveSend.addActionListener(this);

        moKeyScale.setKeySettings(miClient, SGuiUtils.getLabelName(jlScale.getText()), true);
        moTextTicket.setTextSettings(SGuiUtils.getLabelName(jlTicket), 10, 1);
        moKeyProducer.setKeySettings(miClient, SGuiUtils.getLabelName(jlProducer.getText()), true);
        moKeyItem.setKeySettings(miClient, SGuiUtils.getLabelName(jlItem.getText()), true);
        moKeyInputSource.setKeySettings(miClient, SGuiUtils.getLabelName(jlInputSource.getText()), true);
        moKeyRegion.setKeySettings(miClient, SGuiUtils.getLabelName(jlRegion.getText()), true);
        moTextPlates.setTextSettings(SGuiUtils.getLabelName(jlPlates.getText()), 25);
        moTextPlatesCage.setTextSettings(SGuiUtils.getLabelName(jlPlatesCage.getText()), 25, 0);
        moTextDriver.setTextSettings(SGuiUtils.getLabelName(jlDriver.getText()), 150);
        moBoolWeightSourceAvailable.setBooleanSettings(SGuiUtils.getLabelName(moBoolWeightSourceAvailable.getText()), false);
        moDecWeightSource.setDecimalSettings(SGuiUtils.getLabelName(jlWeightSource.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, true);
        moDecWeightDestinyArrival.setDecimalSettings(SGuiUtils.getLabelName(jlWeightDestinyArrival.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, true);
        moDecWeightDestinyDeparture.setDecimalSettings(SGuiUtils.getLabelName(jlWeightDestinyDeparture.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, true);
        moDatetimeArrival.setDateSettings(miClient, SGuiUtils.getLabelName(jlDatetimeArrival.getText()), true);
        moDatetimeDeparture.setDateSettings(miClient, SGuiUtils.getLabelName(jlDatetimeDeparture.getText()), true);
        moTextNote.setTextSettings(SGuiUtils.getLabelName(jlNote.getText()), 255, 0);
        moDecPackingFullQuantityArrival.setDecimalSettings(SGuiUtils.getLabelName(jlPackingQuantityArrival.getText()) + "/ " + SGuiUtils.getLabelName(jlPackingFull.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        moDecPackingEmptyQuantityArrival.setDecimalSettings(SGuiUtils.getLabelName(jlPackingQuantityArrival.getText()) + "/ " + SGuiUtils.getLabelName(jlPackingEmpty.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        moDecPackingFullQuantityDeparture.setDecimalSettings(SGuiUtils.getLabelName(jlPackingQuantityDeparture.getText()) + "/ " + SGuiUtils.getLabelName(jlPackingFull.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        moDecPackingEmptyQuantityDeparture.setDecimalSettings(SGuiUtils.getLabelName(jlPackingQuantityDeparture.getText()) + "/ " + SGuiUtils.getLabelName(jlPackingEmpty.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        moKeyTicketOrigin.setKeySettings(miClient, SGuiUtils.getLabelName(jlTicketOrigin.getText()), true);
        moKeyExwFacilityOrigin.setKeySettings(miClient, SGuiUtils.getLabelName(jlExwFacilityOrigin.getText()), true);
        moKeyTicketDestination.setKeySettings(miClient, SGuiUtils.getLabelName(jlTicketDestination.getText()), true);
        moKeyExwFacilityDestination.setKeySettings(miClient, SGuiUtils.getLabelName(jlExwFacilityDestination.getText()), true);
        moTextExwUpdateNote.setTextSettings(SGuiUtils.getLabelName(jlExwUpdateNote.getText()), 255, 1);
        moRadFreightFreight.setBooleanSettings(moRadFreightFreight.getText(), false);
        moKeyFreightOrigin.setKeySettings(miClient, SGuiUtils.getLabelName(jlFreightOrigin), true);
        moRadFreightDependent.setBooleanSettings(moRadFreightDependent.getText(), false);
        moKeyFreightTicket.setKeySettings(miClient, SGuiUtils.getLabelName(jlFreightTicket), true);

        moFields.addField(moKeyScale);
        moFields.addField(moTextTicket);
        moFields.addField(moKeyProducer);
        moFields.addField(moKeyItem);
        moFields.addField(moKeyInputSource);
        moFields.addField(moKeyRegion);
        moFields.addField(moTextPlates);
        moFields.addField(moTextPlatesCage);
        moFields.addField(moTextDriver);
        moFields.addField(moBoolWeightSourceAvailable);
        moFields.addField(moDecWeightSource);
        moFields.addField(moDecWeightDestinyArrival);
        moFields.addField(moDecWeightDestinyDeparture);
        moFields.addField(moDatetimeArrival);
        moFields.addField(moDatetimeDeparture);
        moFields.addField(moTextNote);
        moFields.addField(moDecPackingFullQuantityArrival);
        moFields.addField(moDecPackingEmptyQuantityArrival);
        moFields.addField(moDecPackingFullQuantityDeparture);
        moFields.addField(moDecPackingEmptyQuantityDeparture);
        moFields.addField(moKeyTicketOrigin);
        moFields.addField(moKeyExwFacilityOrigin);
        moFields.addField(moKeyTicketDestination);
        moFields.addField(moKeyExwFacilityDestination);
        moFields.addField(moTextExwUpdateNote);
        moFields.addField(moRadFreightFreight);
        moFields.addField(moKeyFreightOrigin);
        moFields.addField(moRadFreightDependent);
        moFields.addField(moKeyFreightTicket);
        
        // read-only fields:

        moTextScaleOperatorArrival.setTextSettings(SGuiUtils.getLabelName(jlScaleOperatorArrival.getText()), 35, 0);
        moTextScaleOperatorDeparture.setTextSettings(SGuiUtils.getLabelName(jlScaleOperatorDeparture.getText()), 35, 0);
        moDecPackingWeight.setDecimalSettings(SGuiUtils.getLabelName(jlPackingWeight.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        moDecWeightAverage.setDecimalSettings(SGuiUtils.getLabelName(jlWeightAverage.getText()), SGuiConsts.GUI_TYPE_DEC_QTY, false);
        
        // other settings:
        
        moKeyFreightTicket.removeAllItems();
        moKeyFreightTicket.addItem(new SGuiItem("- Boleto del flete -"));

        moFields.setFormButton(jbSave);

        jpCommandCenter.add(jbSaveSend);
        
        jlWeightSourceUnit.setText(SSomConsts.KG);
        jlWeightDestinyArrivalUnit.setText(SSomConsts.KG);
        jlWeightDestinyDepartureUnit.setText(SSomConsts.KG);
        jlPackingWeightUnit.setText(SSomConsts.KG);
        
        msScaleRevuelta = miClient.getSession().readField(SModConsts.SU_SCA, new int[] { SModSysConsts.SU_SCA_REV }, SDbRegistry.FIELD_NAME).toString();
        msCommentsArrival = "";
        msCommentsDeparture = "";
    }

    private void closeConnectionRevuelta() {
        if (moConnectionRevuelta != null) {
            try {
                if (!moConnectionRevuelta.isClosed()) {
                    moConnectionRevuelta.close();
                }
            }
            catch (Exception e) {
                SLibUtils.showException(this, e);
            }
        }
    }

    private boolean isFormForTicketTare() {
        return mnFormSubtype == SModConsts.SX_TIC_TARE_PEND;
    }

    private boolean isFormForTicketExwUpdate() {
        return mnFormSubtype == SModConsts.SX_TIC_UPD;
    }

    private boolean isRequireItem() {
        return moKeyProducer.getSelectedIndex() > 0;
    }

    private boolean isRequiredRegion() {
        return moKeyRegion.getItemCount() > 2;
    }

    private boolean isRequiredInputSource() {
        return moKeyInputSource.getItemCount() > 1;
    }

    private boolean isRequiredExwFacilityOrigin() {
        return moKeyTicketOrigin.getSelectedIndex() > 0 && moKeyTicketOrigin.getValue()[0] == SModSysConsts.SU_TIC_ORIG_EXW;
    }

    private boolean isRequiredExwFacilityDestination() {
        return moKeyTicketDestination.getSelectedIndex() > 0 && moKeyTicketDestination.getValue()[0] == SModSysConsts.SU_TIC_DEST_EXW;
    }

    private boolean checkFreightRequired() {
        boolean isRequired = false;
        
        try {
            if (moItem != null && SSomUtils.getRequiredFreightForItem(miClient.getSession(), moItem.getPkItemId()).equals(SDbTicket.REQ_FRT_YES)) {
                isRequired = true;
            }
        }
        catch (Exception e) {
            miClient.showMsgBoxError(e.getMessage());
        }
        
        return isRequired;
    }

    private void enableFields() {
        if (moRegistry.isAlternative() && !isFormForTicketExwUpdate()) {
            moKeyScale.setEnabled(false);
            moTextTicket.setEditable(false);
            jbImportTicket.setEnabled(false);
            jbCleanTicket.setEnabled(false);
            moKeyProducer.setEnabled(false);
            moKeyItem.setEnabled(false);
            moKeyInputSource.setEnabled(false);
            jbSetDefaultInputSource.setEnabled(false);
            moKeyRegion.setEnabled(false);
            
            moTextPlates.setEditable(false);
            moTextPlatesCage.setEditable(false);
            moTextDriver.setEditable(false);
            
            moBoolWeightSourceAvailable.setEnabled(false);
            moDecWeightSource.setEditable(false);
            moDecWeightDestinyArrival.setEditable(false);
            moDecWeightDestinyDeparture.setEditable(false);
            jbImportTicketTare.setEnabled(false);
            jbCleanTicketTare.setEnabled(false);
            moDatetimeArrival.setEditable(false);
            moDatetimeDeparture.setEditable(false);
            moTextNote.setEnabled(false);
            
            moDecPackingFullQuantityArrival.setEditable(false);
            moDecPackingEmptyQuantityArrival.setEditable(false);
            jbEditPackingFullQuantityArrival.setEnabled(false);
            jbEditPackingEmptyQuantityArrival.setEnabled(false);
            moDecPackingFullQuantityDeparture.setEditable(false);
            moDecPackingEmptyQuantityDeparture.setEditable(false);
            
            moKeyTicketOrigin.setEnabled(false);
            moKeyExwFacilityOrigin.setEnabled(false);
            moKeyTicketDestination.setEnabled(false);
            moKeyExwFacilityDestination.setEnabled(false);
            
            moTextExwUpdateNote.setEditable(false);
            
            moRadFreightFreight.setEnabled(false);
            moRadFreightDependent.setEnabled(false);
            actionRadEnableFreight();
            
            jbSaveSend.setEnabled(false);
            jbSave.setEnabled(false);
        }
        else {
            /* Cases:
             * 1. Ticket to be updated on external warehouses.
             * 2. Ticket to be tared.
             * 3. Ticket creation (not tared yet obviously!)
             * 4. Ticket modification (not tared yet obviously!)
             * Notes:
             * 1. Data at arrival required on ticket creation or modification.
             * 2. Data at departure required when ticket is tared.
             */
            
            if (isFormForTicketExwUpdate()) {
                // Case 1: Ticket to be updated on external warehouses.
                
                moKeyScale.setEnabled(false);
                moTextTicket.setEditable(false);
                jbImportTicket.setEnabled(false);
                jbCleanTicket.setEnabled(false);
                moKeyProducer.setEnabled(false);
                moKeyItem.setEnabled(false);
                moKeyInputSource.setEnabled(false);
                jbSetDefaultInputSource.setEnabled(false);
                moKeyRegion.setEnabled(false);
                
                moTextPlates.setEditable(false);
                moTextPlatesCage.setEditable(false);
                moTextDriver.setEditable(false);
                
                moBoolWeightSourceAvailable.setEnabled(false);
                moDecWeightSource.setEditable(false);
                moDecWeightDestinyArrival.setEditable(false);
                moDecWeightDestinyDeparture.setEditable(false);
                jbImportTicketTare.setEnabled(false);
                jbCleanTicketTare.setEnabled(false);
                moDatetimeArrival.setEditable(false);
                moDatetimeDeparture.setEditable(false);
                moTextNote.setEnabled(false);
                
                moDecPackingFullQuantityArrival.setEditable(false);
                moDecPackingEmptyQuantityArrival.setEditable(false);
                jbEditPackingFullQuantityArrival.setEnabled(false);
                jbEditPackingEmptyQuantityArrival.setEnabled(false);
                moDecPackingFullQuantityDeparture.setEditable(false);
                moDecPackingEmptyQuantityDeparture.setEditable(false);
                
                moKeyTicketOrigin.setEnabled(true);
                moKeyExwFacilityOrigin.setEnabled(isRequiredExwFacilityOrigin() && moKeyItem.getSelectedIndex() > 0);
                moKeyTicketDestination.setEnabled(true);
                moKeyExwFacilityDestination.setEnabled(isRequiredExwFacilityDestination() && moKeyItem.getSelectedIndex() > 0);
                
                moTextExwUpdateNote.setEditable(true);
                
                moRadFreightFreight.setEnabled(false);
                moRadFreightDependent.setEnabled(false);
                actionRadEnableFreight();
                
                jbSaveSend.setEnabled(false);
            }
            else if (isFormForTicketTare()) {
                // Case 2: Ticket to be tared.
                
                moKeyScale.setEnabled(false);
                moTextTicket.setEditable(false);
                jbImportTicket.setEnabled(false);
                jbCleanTicket.setEnabled(false);
                moKeyProducer.setEnabled(false);
                moKeyItem.setEnabled(false);
                moKeyInputSource.setEnabled(isRequiredInputSource());
                jbSetDefaultInputSource.setEnabled(isRequiredInputSource());
                moKeyRegion.setEnabled(isRequiredRegion());
                
                moTextPlates.setEditable(false);
                moTextPlatesCage.setEditable(false);
                moTextDriver.setEditable(false);
                
                moBoolWeightSourceAvailable.setEnabled(false);
                moDecWeightSource.setEditable(false);
                moDecWeightDestinyArrival.setEditable(false);
                moDecWeightDestinyDeparture.setEditable(!mbIsRevImport2);
                jbImportTicketTare.setEnabled(moConnectionRevuelta != null);
                jbCleanTicketTare.setEnabled(mbIsRevImport2);
                moDatetimeArrival.setEditable(false);
                moDatetimeDeparture.setEditable(!mbIsRevImport2);
                moTextNote.setEnabled(!mbIsRevImport1);
                
                moDecPackingFullQuantityArrival.setEditable(false);
                moDecPackingEmptyQuantityArrival.setEditable(false);
                jbEditPackingFullQuantityArrival.setEnabled(mbIsPacking);
                jbEditPackingEmptyQuantityArrival.setEnabled(mbIsPacking);
                moDecPackingFullQuantityDeparture.setEditable(mbIsPacking);
                moDecPackingEmptyQuantityDeparture.setEditable(mbIsPacking);
                
                moKeyTicketOrigin.setEnabled(true);
                moKeyExwFacilityOrigin.setEnabled(isRequiredExwFacilityOrigin() && moKeyItem.getSelectedIndex() > 0);
                moKeyTicketDestination.setEnabled(true);
                moKeyExwFacilityDestination.setEnabled(isRequiredExwFacilityDestination() && moKeyItem.getSelectedIndex() > 0);
                
                moTextExwUpdateNote.setEditable(false);
                
                moRadFreightFreight.setEnabled(mbIsFreightRequired);
                moRadFreightDependent.setEnabled(mbIsFreightRequired);
                actionRadEnableFreight();
                
                jbSaveSend.setEnabled(moRegistry.getFkTicketStatusId() == SModSysConsts.SS_TIC_ST_SCA);
            }
            else {
                if (moRegistry.isRegistryNew()) {
                    // Case 3: Ticket creation (not tared yet obviously!)
                    
                    // NOTICE: Argument "enableFields" ONLY enables/disables fields related to 1st data imported from Revuelta!
                    
                    moKeyScale.setEnabled(!mbIsRevImport1 && moKeyScale.getItemCount() > 0 && moKeyScale.getItemCount() != 2);
                    moTextTicket.setEditable(!mbIsRevImport1);
                    jbImportTicket.setEnabled(moConnectionRevuelta != null);
                    jbCleanTicket.setEnabled(mbIsRevImport1);
                    moKeyProducer.setEnabled(!mbIsRevImport1);
                    moKeyItem.setEnabled(!mbIsRevImport1 && isRequireItem());
                    moKeyInputSource.setEnabled(isRequiredInputSource());
                    jbSetDefaultInputSource.setEnabled(isRequiredInputSource()); 
                    moKeyRegion.setEnabled(isRequiredRegion());
                    
                    moTextPlates.setEditable(!mbIsRevImport1);
                    moTextPlatesCage.setEditable(true);
                    moTextDriver.setEditable(!mbIsRevImport1);
                    
                    moBoolWeightSourceAvailable.setEnabled(true);
                    moDecWeightSource.setEditable(moBoolWeightSourceAvailable.isSelected());
                    moDecWeightDestinyArrival.setEditable(!mbIsRevImport1);
                    moDecWeightDestinyDeparture.setEditable(false);
                    jbImportTicketTare.setEnabled(false);
                    jbCleanTicketTare.setEnabled(false);
                    moDatetimeArrival.setEditable(!mbIsRevImport1);
                    moDatetimeDeparture.setEditable(false);
                    moTextNote.setEnabled(!mbIsRevImport1);
                    
                    moDecPackingFullQuantityArrival.setEditable(mbIsPacking);
                    moDecPackingEmptyQuantityArrival.setEditable(mbIsPacking);
                    jbEditPackingFullQuantityArrival.setEnabled(false);
                    jbEditPackingEmptyQuantityArrival.setEnabled(false);
                    moDecPackingFullQuantityDeparture.setEditable(false);
                    moDecPackingEmptyQuantityDeparture.setEditable(false);
                    
                    moKeyTicketOrigin.setEnabled(true);
                    moKeyExwFacilityOrigin.setEnabled(isRequiredExwFacilityOrigin() && moKeyItem.getSelectedIndex() > 0);
                    moKeyTicketDestination.setEnabled(true);
                    moKeyExwFacilityDestination.setEnabled(isRequiredExwFacilityDestination() && moKeyItem.getSelectedIndex() > 0);
                    
                    moTextExwUpdateNote.setEditable(false);
                    
                    moRadFreightFreight.setEnabled(mbIsFreightRequired);
                    moRadFreightDependent.setEnabled(mbIsFreightRequired);
                    actionRadEnableFreight();
                    
                    jbSaveSend.setEnabled(false);
                }
                else {
                    // Case 4: Ticket modification (may or not be tared)
                    
                    moKeyScale.setEnabled(!moRegistry.isTared() && !mbIsRevImport1 && moKeyScale.getItemCount() > 0 && moKeyScale.getItemCount() != 2);
                    moTextTicket.setEditable(!moRegistry.isTared() && !mbIsRevImport1);
                    jbImportTicket.setEnabled(!moRegistry.isTared() && moConnectionRevuelta != null);
                    jbCleanTicket.setEnabled(!moRegistry.isTared() && mbIsRevImport1);
                    moKeyProducer.setEnabled(!moRegistry.isTared() && !mbIsRevImport1);
                    moKeyItem.setEnabled(!moRegistry.isTared() && !mbIsRevImport1 && isRequireItem());
                    moKeyInputSource.setEnabled(!moRegistry.isTared() && isRequiredInputSource());
                    jbSetDefaultInputSource.setEnabled(!moRegistry.isTared() && isRequiredInputSource());
                    moKeyRegion.setEnabled(!moRegistry.isTared() && isRequiredRegion());
                    
                    moTextPlates.setEditable(!moRegistry.isTared() && !mbIsRevImport1);
                    moTextPlatesCage.setEditable(!moRegistry.isTared());
                    moTextDriver.setEditable(!moRegistry.isTared() && !mbIsRevImport1);
                    
                    moBoolWeightSourceAvailable.setEnabled(!moRegistry.isTared());
                    moDecWeightSource.setEditable(!moRegistry.isTared() && moBoolWeightSourceAvailable.isSelected());
                    moDecWeightDestinyArrival.setEditable(!moRegistry.isTared() && !mbIsRevImport1);
                    moDecWeightDestinyDeparture.setEditable(false);
                    jbImportTicketTare.setEnabled(false);
                    jbCleanTicketTare.setEnabled(false);
                    moDatetimeArrival.setEditable(!moRegistry.isTared() && !mbIsRevImport1);
                    moDatetimeDeparture.setEditable(false);
                    moTextNote.setEnabled(!moRegistry.isTared() && !mbIsRevImport1);
                    
                    moDecPackingFullQuantityArrival.setEditable(!moRegistry.isTared() && mbIsPacking);
                    moDecPackingEmptyQuantityArrival.setEditable(!moRegistry.isTared() && mbIsPacking);
                    jbEditPackingFullQuantityArrival.setEnabled(false);
                    jbEditPackingEmptyQuantityArrival.setEnabled(false);
                    moDecPackingFullQuantityDeparture.setEditable(false);
                    moDecPackingEmptyQuantityDeparture.setEditable(false);

                    moKeyTicketOrigin.setEnabled(true);
                    moKeyExwFacilityOrigin.setEnabled(isRequiredExwFacilityOrigin() && moKeyItem.getSelectedIndex() > 0);
                    moKeyTicketDestination.setEnabled(true);
                    moKeyExwFacilityDestination.setEnabled(isRequiredExwFacilityDestination() && moKeyItem.getSelectedIndex() > 0);
                    
                    moTextExwUpdateNote.setEditable(false);
                    
                    moRadFreightFreight.setEnabled(mbIsFreightRequired);
                    moRadFreightDependent.setEnabled(mbIsFreightRequired);
                    actionRadEnableFreight();
                    
                    jbSaveSend.setEnabled(moRegistry.getFkTicketStatusId() == SModSysConsts.SS_TIC_ST_SCA && moRegistry.isTared());
                }
            }
        }
    }

    private void readRegion() {
        mnSeasonId = 0;
        moKeyRegion.removeAllItems();

        try {
            if (moKeyProducer.getSelectedIndex() > 0 && moKeyItem.getSelectedIndex() > 0) {
                mnSeasonId = SSomUtils.getProperSeasonId(miClient.getSession(), moDatetimeArrival.getValue(), moKeyItem.getValue()[0], moKeyProducer.getValue()[0]);

                SGuiParams params = new SGuiParams();
                params.getParamsMap().put(SModConsts.SU_SEAS, mnSeasonId);
                params.getParamsMap().put(SModConsts.SU_PROD, moKeyProducer.getValue()[0]);
                params.getParamsMap().put(SModConsts.SU_ITEM, moKeyItem.getValue()[0]);
                
                miClient.getSession().populateCatalogue(moKeyRegion, SModConsts.SX_PROD_REG_ITEM_SEAS, 0, params);
                
                if (moKeyRegion.getItemCount() == 2) {
                    moKeyRegion.setSelectedIndex(1);
                }
            }
        }
        catch (Exception e) {
             SLibUtils.showException(this, e);
        }
    }

    private void computeWeightAverage() {
        if (!mbIsPacking || moDecWeightDestinyDeparture.getValue() == 0) {
            moDecWeightAverage.setValue(0d);
        }
        else {
            double tareWeight = moDecWeightDestinyArrival.getValue() - moDecWeightDestinyDeparture.getValue();
            double packingNetWeight = (moDecPackingFullQuantityArrival.getValue() + moDecPackingEmptyQuantityArrival.getValue() + moDecPackingFullQuantityDeparture.getValue() + moDecPackingEmptyQuantityDeparture.getValue()) * moItem.getPackingWeight();
            double fullPackingNetQuantity = moDecPackingFullQuantityArrival.getValue() - moDecPackingFullQuantityDeparture.getValue();
            
            moDecWeightAverage.setValue(fullPackingNetQuantity == 0d ? 0d : ((tareWeight - packingNetWeight) / fullPackingNetQuantity));
        }
    }

    private void reloadFreightTicketsCatalog() {
        SGuiParams params = new SGuiParams();
        params.getParamsMap().put(SModConsts.SU_INP_CT, moItem != null ? moItem.getFkInputCategoryId() : 0);
        params.getParamsMap().put(SModConsts.SX_PARAM_TIC_DATE, moRegistry.getDate() != null ? moRegistry.getDate() : miClient.getSession().getWorkingDate());
        
        miClient.getSession().populateCatalogue(moKeyFreightTicket, SModConsts.SX_TIC_FREIGHT, 0, params);
    }

    private void itemStateKeyProducer() {
        try {
            mbProcessingProducer = true;
            
            // reset member:

            moProducer = null;

            // disable items fields:

            moKeyItem.setEnabled(false);
            moKeyInputSource.setEnabled(false);

            // reset ticket's origin and destination fields:

            moKeyTicketOrigin.resetField();
            moKeyTicketDestination.resetField();

            if (moKeyProducer.getSelectedIndex() > 0) {
                // set members:

                moProducer = (SDbProducer) miClient.getSession().readRegistry(SModConsts.SU_PROD, moKeyProducer.getValue());

                // reset items fields:

                moKeyInputSource.setValue(new int[] { moProducer.getFkInputSourceId() });

                // set ticket's origin and destination fields:

                if (moProducer.getPkProducerId() != mnCompanyId) {
                    // producer is supplier:
                    moKeyTicketOrigin.setValue(new int[] { SModSysConsts.SU_TIC_ORIG_SUP });
                    moKeyTicketDestination.setValue(new int[] { SModSysConsts.SU_TIC_DEST_FAC });
                }
                else {
                    // producer is this company:
                    moKeyTicketOrigin.setValue(new int[] { SModSysConsts.SU_TIC_ORIG_EXW });
                    moKeyTicketDestination.setValue(new int[] { SModSysConsts.SU_TIC_DEST_FAC });
                }

                // complete producer setup:

                readRegion();
                enableFields();
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
        finally {
            mbProcessingProducer = false;
        }
    }

    @SuppressWarnings("unchecked")
    private void itemStateKeyItem() {
        // reset members:
        
        moItem = null;
        mbIsPacking = false;
        mbIsLaboratory = false;
        mbIsFreightRequired = false;
        
        // reset packing units fields:
        
        moDecPackingFullQuantityArrival.setValue(0d);
        moDecPackingEmptyQuantityArrival.setValue(0d);
        moDecPackingFullQuantityDeparture.setValue(0d);
        moDecPackingEmptyQuantityDeparture.setValue(0d);
        jlPackingFullQuantityArrivalUnits.setText("");
        jlPackingEmptyQuantityArrivalUnits.setText("");
        jlPackingFullQuantityDepartureUnits.setText("");
        jlPackingEmptyQuantityDepartureUnits.setText("");
        
        moDecPackingWeight.setValue(0d);
        moDecWeightAverage.setValue(0d);
        jlWeightAverageUnits.setText("");
        
        moDecPackingFullQuantityArrival.setEditable(false);
        moDecPackingEmptyQuantityArrival.setEditable(false);
        jbEditPackingFullQuantityArrival.setEnabled(false);
        jbEditPackingEmptyQuantityArrival.setEnabled(false);
        moDecPackingFullQuantityDeparture.setEditable(false);
        moDecPackingEmptyQuantityDeparture.setEditable(false);
        
        // reset input source field:
        
        moKeyInputSource.removeAllItems();
        moKeyInputSource.setEnabled(false);
        
        // reset external warehouses fields:
        
        moKeyExwFacilityOrigin.removeAllItems();
        moKeyExwFacilityOrigin.addItem(new SGuiItem("- Almacén externo -"));
        moKeyExwFacilityOrigin.setEnabled(false);
        
        moKeyExwFacilityDestination.removeAllItems();
        moKeyExwFacilityDestination.addItem(new SGuiItem("- Almacén externo -"));
        moKeyExwFacilityDestination.setEnabled(false);
        
        // reset freight control fields:

        moRadFreightFreight.setEnabled(false);
        moRadFreightDependent.setEnabled(false);
        
        bgFreightType.clearSelection();
        actionRadEnableFreight();
        
        if (moKeyItem.getSelectedIndex() > 0) {
            // set members:
            
            moItem = (SDbItem) miClient.getSession().readRegistry(SModConsts.SU_ITEM, moKeyItem.getValue());
            mbIsPacking = moItem.isPacking();
            mbIsLaboratory = moItem.isLaboratory();
            mbIsFreightRequired = checkFreightRequired();
            
            // set packing units fields:

            if (mbIsPacking) {
                jlPackingFullQuantityArrivalUnits.setText(moItem.getPackingName());
                jlPackingEmptyQuantityArrivalUnits.setText(moItem.getPackingName());
                jlPackingFullQuantityDepartureUnits.setText(moItem.getPackingName());
                jlPackingEmptyQuantityDepartureUnits.setText(moItem.getPackingName());
                
                jlWeightAverageUnits.setText(SSomConsts.KG + " / " + moItem.getPackingName());
                
                moDecPackingWeight.setValue(moItem.getPackingWeight());
            }
            
            // set input source field:

            miClient.getSession().populateCatalogue(moKeyInputSource, SModConsts.SU_INP_SRC, 0, new SGuiParams(moItem.getFkInputCategoryId()));
            
            if (moProducer != null) {
                moKeyInputSource.setValue(new int[] { moProducer.getFkInputSourceId() });
            }
            
            if (moKeyInputSource.getSelectedIndex() <= 0 && moKeyInputSource.getItemCount() == 2) {
                moKeyInputSource.setSelectedIndex(1);
            }
            
            // set external warehouses fields:
            
            if (moItem.getExternalWarehousesAllowed().isEmpty()) {
                // add all external warehouses, except "NA":
                
                for (SGuiItem guiItem : maExternalWarehouses) {
                    if (guiItem.getPrimaryKey()[0] != SModSysConsts.MU_EXW_FAC_NA) {
                        moKeyExwFacilityOrigin.addItem(guiItem);
                        moKeyExwFacilityDestination.addItem(guiItem);
                    }
                }
            }
            else {
                // add only item's external warehouses:
                
                String[] ids = moItem.getExternalWarehousesAllowed().split(";");
                
                for (String id : ids) {
                    int externalWarehouseId = SLibUtils.parseInt(id);
                    
                    for (SGuiItem guiItem : maExternalWarehouses) {
                        if (externalWarehouseId == guiItem.getPrimaryKey()[0]) {
                            moKeyExwFacilityOrigin.addItem(guiItem);
                            moKeyExwFacilityDestination.addItem(guiItem);
                        }
                    }
                }
            }
            
            // complete item setup:

            reloadFreightTicketsCatalog();
            
            readRegion();
            enableFields();
        }
    }

    private void itemStateKeyTicketOrigin() {
        if (isRequiredExwFacilityOrigin()) {
            moKeyExwFacilityOrigin.setEnabled(moKeyItem.getSelectedIndex() > 0);
            
            if (moKeyExwFacilityOrigin.isEnabled() && moKeyExwFacilityOrigin.getItemCount() == 2) {
                moKeyExwFacilityOrigin.setSelectedIndex(1);
            }
        }
        else {
            moKeyExwFacilityOrigin.setEnabled(false);
            moKeyExwFacilityOrigin.resetField();
        }
    }

    private void itemStateKeyTicketDestination() {
        if (isRequiredExwFacilityDestination()) {
            moKeyExwFacilityDestination.setEnabled(moKeyItem.getSelectedIndex() > 0);
            
            if (moKeyExwFacilityDestination.isEnabled() && moKeyExwFacilityDestination.getItemCount() == 2) {
                moKeyExwFacilityDestination.setSelectedIndex(1);
            }
        }
        else {
            moKeyExwFacilityDestination.setEnabled(false);
            moKeyExwFacilityDestination.resetField();
        }
    }

    private void itemStateWeightSourceAvailable() {
        moDecWeightSource.setEditable(moBoolWeightSourceAvailable.isSelected());
    }

    private void actionImportTicket() {
        try {
            if (moConnectionRevuelta != null) {
                if (moKeyScale.getSelectedIndex() > 0) {
                    if (moKeyScale.getValue()[0] == SModSysConsts.SU_SCA_REV) {
                        if (!moTextTicket.getValue().isEmpty()) {
                            if (!SSomUtils.existsTicket(miClient.getSession(), moTextTicket.getValue(), moRegistry.getPkTicketId())) {
                                try (Statement statement = moConnectionRevuelta.createStatement()) {
                                    /* XXX used when ODBC was supported by JVM (Sergio Flores 2015-06-24)
                                    sql = "SELECT be.clave_e, DateValue(be.fecha_e) + TimeValue(be.hora_e), be.placas, be.observa_e, be.conductor, be.peso_e, " + // 6
                                            "be.clave_p, be.clave_c, be.clave_o, be.nombre_oe, be.turno_oe, be.bascula_e, p.nombre_p, c.nombre_c " + // 14
                                            "FROM ((boleto_ent AS be " +
                                            "INNER JOIN producto AS p ON be.clave_p = p.clave_p) " +
                                            "INNER JOIN cliente AS c ON be.clave_c = c.clave_c) " +
                                            "WHERE be.clave_e = " + moIntTicket.getValue() + " AND be.fecha_e = #" + dateFormatDateShort.format(moDatetimeArrival.getValue()) + "# ";
                                    */
                                    /* Deprecation due to change of DBMS of Revuelta's scale software (Alfredo Pérez, 2018-02-19)
                                    sql = "SELECT 
                                            be.clave_e,
                                            CAST(DATE(be.fecha_e) AS SQL_CHAR) + ' ' + be.hora_e, 
                                            be.placas, 
                                            be.observa_e,
                                            be.conductor, 
                                            be.peso_e, " +  // 6
                                            "be.clave_p,
                                            be.clave_c,     //8
                                            be.clave_o,     
                                            be.nombre_oe,   //10 
                                            be.turno_oe, 
                                            be.bascula_e,   //12
                                            p.nombre_p,
                                            c.nombre_c " + // 14
                                            "FROM ((boleto_ent AS be " +
                                            "INNER JOIN producto AS p ON be.clave_p = p.clave_p) " +
                                            "INNER JOIN cliente AS c ON be.clave_c = c.clave_c) " +
                                            "WHERE be.clave_e = " + moIntTicket.getValue() + " AND be.fecha_e = '" + SLibUtils.DbmsDateFormatDate.format(moDatetimeArrival.getValue()) + "' ";
                                    */

                                    String sql = "SELECT Pes_ID, Pro_ID, Emp_ID, Pes_Placas, Pes_Chofer, Pes_FecHorPri, Usb_Nombre, Emp_Nombre, Pro_Nombre, "
                                            + "Pes_BasPri, Pes_OpeNomPri, Pes_ObsPri, Pes_PesoPri, Pes_FecHorSeg, Pes_BasSeg, Pes_Bruto, Pes_Tara, Pes_Neto, Pes_OpeNomSeg, Pes_ObsSeg "
                                            + "FROM dba.Pesadas "
                                            + "WHERE Pes_ID = " + moTextTicket.getValue();

                                    ResultSet resulset = statement.executeQuery(sql);
                                    if (resulset.next()) {
                                        String producerRevId = resulset.getString("Emp_ID");
                                        String itemRevId = resulset.getString("Pro_ID");

                                        int producerId = SSomUtils.mapProducerSomRevuelta(miClient.getSession(), producerRevId);
                                        int itemId = SSomUtils.mapItemSomRevuelta(miClient.getSession(), itemRevId);

                                        if (producerId > 0) {
                                            if (itemId > 0) {
                                                /* Deprecation due to change of DBMS of Revuelta's scale software (Alfredo Pérez, 2018-02-19)
                                                moTextPlates.setValue(resulset.getString(3));
                                                moTextDriver.setValue(resulset.getString(5));
                                                moDecWeightDestinyArrival.setValue(resulset.getDouble(6));
                                                moDatetimeArrival.setValue(SLibUtils.DbmsDateFormatDatetime.parse(resulset.getString(2)));
                                                moDatetimeArrival.setValue(datetimeParser.parse(resulset.getString(2).replaceAll("a.m.", "AM").replaceAll("p.m.", "PM")));
                                                moTextNote.setValue(resulset.getString(4));
                                                */
                                                
                                                try {
                                                    mbSettingForm = true;
                                                    
                                                    mbIsRevImport1 = true;
                                                    
                                                    moKeyProducer.setValue(new int [] { producerId });
                                                    itemStateKeyProducer();
                                                    
                                                    moKeyItem.setValue(new int [] { itemId });
                                                    itemStateKeyItem();

                                                    moTextPlates.setValue(resulset.getString("Pes_Placas"));
                                                    moTextDriver.setValue(resulset.getString("Pes_Chofer"));

                                                    moDecWeightDestinyArrival.setValue(resulset.getDouble("Pes_PesoPri"));
                                                    moDatetimeArrival.setValue((resulset.getTimestamp("Pes_FecHorPri")));
                                                    String operator = resulset.getString("Pes_OpeNomPri");
                                                    moTextScaleOperatorArrival.setValue(operator == null || operator.equals("null") ? "" : operator);
                                                    String comments = resulset.getString("Pes_ObsPri");
                                                    msCommentsArrival = comments == null || comments.equals("null") ? "" : comments;
                                                    moTextNote.setValue(msCommentsArrival);
                                                }
                                                catch (Exception e) {
                                                    mbIsRevImport1 = false;
                                                    SLibUtils.showException(this, e);
                                                }
                                                finally {
                                                    enableFields();
                                                    mbSettingForm = false;
                                                    
                                                    if (mbIsRevImport1) {
                                                        moKeyInputSource.requestFocusInWindow();
                                                    }
                                                }
                                            }
                                            else {
                                                miClient.showMsgBoxInformation("No se encontró el mapeo para el producto '" + resulset.getString("Pro_Nombre") + "', en el catálogo de ítems de SOM.");
                                            }
                                        }
                                        else {
                                            miClient.showMsgBoxInformation("No se encontró el mapeo para el proveedor '" + resulset.getString("Emp_Nombre") + "', en el catálogo de proveedores de SOM.");
                                        }
                                    }
                                    else {
                                        miClient.showMsgBoxInformation("No se encontró ningún registro para el boleto '" + moTextTicket.getValue() + "', del día '" + SLibUtils.DateFormatDate.format(moDatetimeArrival.getValue()) + "', en el sistema Revuelta.");
                                    }
                                }
                            }
                            else {
                                miClient.showMsgBoxInformation("El boleto '" + moTextTicket.getValue() + "', ya existe.");
                            }
                        }
                        else {
                            moTextTicket.requestFocusInWindow();
                            miClient.showMsgBoxInformation(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlTicket) + "'.");
                        }
                    }
                    else {
                        moKeyScale.requestFocusInWindow();
                        miClient.showMsgBoxInformation(SGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + SGuiUtils.getLabelName(jlScale) + "'" + SGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + msScaleRevuelta + "'.");
                    }
                }
                else {
                    moKeyScale.requestFocusInWindow();
                    miClient.showMsgBoxInformation(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlScale) + "'.");
                }
            }
            else {
                miClient.showMsgBoxWarning("No se pudo establecer comunicación con el sistema Revuelta.");
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    private void actionImportTicketTare() {
        try {
            if (moConnectionRevuelta != null) {
                if (!moRegistry.isRegistryNew()) {
                    if (moRegistry.getFkScaleId() == SModSysConsts.SU_SCA_REV) {
                        if (!moTextTicket.getValue().isEmpty()) {
                            try (Statement statement = moConnectionRevuelta.createStatement()) {
                                //SimpleDateFormat datetimeParser = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss a");
                                //SimpleDateFormat dateFormatDateShort = new SimpleDateFormat("MM/dd/yyyy");    // XXX used when ODBC was supported by JVM (Sergio Flores 2015-06-24)
                                
                                /* XXX used when ODBC was supported by JVM (Sergio Flores 2015-06-24)
                                sql = "SELECT clave_e, DateValue(fecha_s) + TimeValue(hora_s), peso_s " + // 3
                                        "FROM boleto_sal " +
                                        "WHERE clave_e = " + moIntTicket.getValue() + " AND fecha_s = #" + dateFormatDateShort.format(moDatetimeDeparture.getValue()) + "# ";
                                */
                                /* Deprecation due to change of DBMS of Revuelta's scale software (Alfredo Pérez, 2018-02-19)
                                sql = "SELECT clave_e, CAST(DATE(fecha_s) AS SQL_CHAR) + ' ' + hora_s, peso_s " + // 3
                                        "FROM boleto_sal " +
                                        "WHERE clave_e = " + moIntTicket.getValue() + " AND fecha_s = '" + SLibUtils.DbmsDateFormatDate.format(moDatetimeDeparture.getValue()) + "' ";
                                */

                                String sql = "SELECT Pes_ID, Pro_ID, Emp_ID, Pes_FecHorSeg, Pes_BasSeg, Pes_Bruto, Pes_Tara, Pes_Neto,Pes_PesoSeg, Pes_OpeNomSeg, Pes_ObsSeg "
                                        + "FROM dba.Pesadas "
                                        + "WHERE Pes_ID = " + moTextTicket.getValue();
                                ResultSet resulset = statement.executeQuery(sql);
                                if (resulset.next()) {
                                    /* Deprecation due to change of DBMS of Revuelta's scale software (Alfredo Pérez, 2018-02-19)
                                    moDecWeightDestinyDeparture.setValue(resulset.getDouble(3));
                                    moDatetimeDeparture.setValue(SLibUtils.DbmsDateFormatDatetime.parse(resulset.getString(2)));
                                    moDatetimeDeparture.setValue(datetimeParser.parse(resulset.getString(2).replaceAll("a.m.", "AM").replaceAll("p.m.", "PM")));
                                    */
                                    
                                    mbIsRevImport2 = true;
                                    
                                    moDecWeightDestinyDeparture.setValue(resulset.getDouble("Pes_PesoSeg"));
                                    moDatetimeDeparture.setValue(resulset.getTimestamp("Pes_FecHorSeg"));
                                    String operator = resulset.getString("Pes_OpeNomSeg");
                                    moTextScaleOperatorDeparture.setValue(operator == null || operator.equals("null") ? "" : operator);
                                    String comments = resulset.getString("Pes_ObsSeg");
                                    msCommentsDeparture = comments == null || comments.equals("null") ? "" : comments;

                                    enableFields();
                                    
                                    if (moDecPackingFullQuantityDeparture.isEditable()) {
                                        moDecPackingFullQuantityDeparture.requestFocusInWindow();
                                    }
                                    else if (moKeyTicketOrigin.isEnabled()) {
                                        moKeyTicketOrigin.requestFocusInWindow();
                                    }
                                }
                                else {
                                    miClient.showMsgBoxInformation("No se encontró ningún registro para el boleto '" + moTextTicket.getValue() + "', del día '" + SLibUtils.DateFormatDate.format(moDatetimeDeparture.getValue()) + ".");
                                }
                            }
                        }
                        else {
                            miClient.showMsgBoxInformation(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlTicket) + "'.");
                        }
                    }
                    else {
                        miClient.showMsgBoxInformation(SGuiConsts.ERR_MSG_FIELD_VAL_ + "'" + SGuiUtils.getLabelName(jlScale) + "'" + SGuiConsts.ERR_MSG_FIELD_VAL_EQUAL + "'" + msScaleRevuelta + "'.");
                    }
                }
                else {
                    miClient.showMsgBoxInformation("El boleto no puede ser nuevo para importar la segunda pesada.");
                }
            }
            else {
                miClient.showMsgBoxWarning("No se pudo establecer comunicación con el sistema Revuelta.");
            }
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
    }

    private void actionCleanTicket() {
        if (miClient.showMsgBoxConfirm("¿Está seguro(a) que desea borrar los datos de la primer pesada?") == JOptionPane.YES_OPTION) {
            try {
                mbSettingForm = true;
                
                mbIsRevImport1 = false;

                moKeyProducer.resetField();
                moKeyItem.resetField();

                moTextPlates.resetField();
                moTextDriver.resetField();

                moDecWeightDestinyArrival.resetField();
                //moDatetimeArrival.resetField(); // preserve date!
                moTextScaleOperatorArrival.resetField();
                msCommentsArrival = "";
                moTextNote.resetField();
            }
            catch (Exception e) {
                SLibUtils.showException(this, e);
            }
            finally {
                enableFields();
                mbSettingForm = false;
            }
        }
    }

    private void actionCleanTicketTare() {
        if (miClient.showMsgBoxConfirm("¿Está seguro(a) que desea borrar los datos de la segunda pesada?") == JOptionPane.YES_OPTION) {
            mbIsRevImport2 = false;

            moDecWeightDestinyDeparture.resetField();
            //moDatetimeDeparture.resetField(); // preserve date!
            moTextScaleOperatorDeparture.resetField();
            msCommentsDeparture = "";
            
            enableFields();
        }
    }

    private void actionSetDefaultInputSource() {
        if (jbSetDefaultInputSource.isEnabled()) {
            try {
                moKeyInputSource.setValue(new int[] { moProducer.getFkInputSourceId() });
            }
            catch (Exception e){
                miClient.showMsgBoxError("No hay origenes disponibles.");
            }
        }
    }

    private void actionSaveSend() {
        mbSaveSendCalled = true;
        super.actionSave();
    }

    private void actionEditPackingFullQuantityArrival() {
        jbEditPackingFullQuantityArrival.setEnabled(false);
        moDecPackingFullQuantityArrival.setEditable(true);
        moDecPackingFullQuantityArrival.requestFocus();
    }

    private void actionEditPackingEmptyQuantityArrival() {
        jbEditPackingEmptyQuantityArrival.setEnabled(false);
        moDecPackingEmptyQuantityArrival.setEditable(true);
        moDecPackingEmptyQuantityArrival.requestFocus();
    }

    private void actionRadEnableFreight() {
        moKeyFreightOrigin.setEnabled(moRadFreightFreight.isEnabled() && moRadFreightFreight.isSelected());
        moKeyFreightTicket.setEnabled(moRadFreightDependent.isEnabled() && moRadFreightDependent.isSelected());
        
        if (!moKeyFreightOrigin.isEnabled() && moKeyFreightOrigin.getItemCount() > 0 && !isFormForTicketExwUpdate()) {
            moKeyFreightOrigin.setSelectedIndex(0);
        }
        
        if (!moKeyFreightTicket.isEnabled() && moKeyFreightTicket.getItemCount() > 0 && !isFormForTicketExwUpdate()) {
            moKeyFreightTicket.setSelectedIndex(0);
        }
    }

    @Override
    public void addAllListeners() {
        moKeyProducer.addItemListener(this);
        moKeyItem.addItemListener(this);
        moKeyTicketOrigin.addItemListener(this);
        moKeyTicketDestination.addItemListener(this);
        moBoolWeightSourceAvailable.addItemListener(this);
        
        jbImportTicket.addActionListener(this);
        jbCleanTicket.addActionListener(this);
        jbSetDefaultInputSource.addActionListener(this);
        jbImportTicketTare.addActionListener(this);
        jbCleanTicketTare.addActionListener(this);
        jbSaveSend.addActionListener(this);
        jbEditPackingFullQuantityArrival.addActionListener(this);
        moRadFreightFreight.addActionListener(this);
        moRadFreightDependent.addActionListener(this);
        
        moDecWeightSource.addFocusListener(this);
        moDecWeightDestinyArrival.addFocusListener(this);
        moDecWeightDestinyDeparture.addFocusListener(this);
        moDecPackingFullQuantityArrival.addFocusListener(this);
        moDecPackingEmptyQuantityArrival.addFocusListener(this);
        moDecPackingFullQuantityDeparture.addFocusListener(this);
        moDecPackingEmptyQuantityDeparture.addFocusListener(this);
        
        moDatetimeArrival.getComponent().addChangeListener(this);
    }

    @Override
    public void removeAllListeners() {
        moKeyProducer.removeItemListener(this);
        moKeyItem.removeItemListener(this);
        moKeyTicketOrigin.removeItemListener(this);
        moKeyTicketDestination.removeItemListener(this);
        moBoolWeightSourceAvailable.removeItemListener(this);
        
        jbImportTicket.removeActionListener(this);
        jbCleanTicket.removeActionListener(this);
        jbSetDefaultInputSource.removeActionListener(this);
        jbImportTicketTare.removeActionListener(this);
        jbCleanTicketTare.removeActionListener(this);
        jbSaveSend.removeActionListener(this);
        jbEditPackingFullQuantityArrival.removeActionListener(this);
        moRadFreightFreight.removeActionListener(this);
        moRadFreightDependent.removeActionListener(this);
        
        moDecWeightSource.removeFocusListener(this);
        moDecWeightDestinyArrival.removeFocusListener(this);
        moDecWeightDestinyDeparture.removeFocusListener(this);
        moDecPackingFullQuantityArrival.removeFocusListener(this);
        moDecPackingEmptyQuantityArrival.removeFocusListener(this);
        moDecPackingFullQuantityDeparture.removeFocusListener(this);
        moDecPackingEmptyQuantityDeparture.removeFocusListener(this);
        
        moDatetimeArrival.getComponent().removeChangeListener(this);
    }

    @Override
    public void reloadCatalogues() {
        miClient.getSession().populateCatalogue(moKeyScale, SModConsts.CU_USR_SCA, 0, new SGuiParams(new int[] { miClient.getSession().getUser().getPkUserId() }));
        miClient.getSession().populateCatalogue(moKeyItem, SModConsts.SU_ITEM, 0, null);
        miClient.getSession().populateCatalogue(moKeyProducer, SModConsts.SU_PROD, 0, null);
        miClient.getSession().populateCatalogue(moKeyTicketOrigin, SModConsts.SU_TIC_ORIG, 0, null);
        miClient.getSession().populateCatalogue(moKeyTicketDestination, SModConsts.SU_TIC_DEST, 0, null);
        miClient.getSession().populateCatalogue(moKeyFreightOrigin, SModConsts.SU_FREIGHT_ORIG, 0, null);
        
        maExternalWarehouses = new ArrayList<>(miClient.getSession().getModuleByGuiType(SModConsts.MU_EXW_FAC, 0).readItems(SModConsts.MU_EXW_FAC, 0, null));
        maExternalWarehouses.remove(0); // GUI item for input hint is useless!
    }

    @Override
    public void setRegistry(SDbRegistry registry) throws Exception {
        try {
            mbSettingForm = true;
            
            moConnectionRevuelta = SSomUtils.openConnectionRevueltaJdbc(miClient.getSession());
            if (moConnectionRevuelta == null) {
                miClient.showMsgBoxError("No se pudo establecer comunicación con el sistema Revuelta.");
            }

            moRegistry = (SDbTicket) registry;

            mnFormResult = SLibConsts.UNDEFINED;
            mbFirstActivation = true;

            mbSaveSendCalled = false;

            removeAllListeners();
            reloadCatalogues();

            if (moRegistry.isAlternative() && !isFormForTicketExwUpdate()) {
                miClient.showMsgBoxInformation("No se puede modificar este boleto porque tiene un registro en el sistema SOM Orgánico.\n"
                        + "Si es necesario, elimine primero el registro " + moRegistry.getXtaNumAlternative() + " en SOM Orgánico para modificar este boleto."
                        + (moRegistry.getFkTicketStatusId() == SModSysConsts.SS_TIC_ST_SCA && moRegistry.isTared() ? "\nPara enviar este boleto al estado siguiente, puede hacerlo directamente en la vista \"Boletos báscula\"." : ""));
            }

            if (moRegistry.isRegistryNew()) {
                // switch between combobox and text field for scalse:

                moKeyScale.setVisible(true);
                jtfScale.setVisible(false);
                jtfScale.setText("");

                // hide external warehouse note field:

                jlExwUpdateNote.setVisible(false);
                moTextExwUpdateNote.setVisible(false);

                // prepare registry creation:

                moRegistry.initPrimaryKey();
                moRegistry.setDatetimeArrival(miClient.getSession().getWorkingDate());
                moRegistry.setDatetimeDeparture(miClient.getSession().getWorkingDate());
                moRegistry.setWeightSourceAvailable(true); // force user to input source weight
                moRegistry.setFkTicketStatusId(SModSysConsts.SS_TIC_ST_SCA);
                moRegistry.setFkExwFacilityOriginId(SModSysConsts.MU_EXW_FAC_NA);
                moRegistry.setFkExwFacilityDestinationId(SModSysConsts.MU_EXW_FAC_NA);

                jtfRegistryKey.setText("");
            }
            else {
                // switch between combobox and text field for scalse:

                moKeyScale.setVisible(false);
                jtfScale.setVisible(true);
                jtfScale.setText(moRegistry.getXtaScaleName());

                // show, if necessary, external warehouse note field:

                jlExwUpdateNote.setVisible(isFormForTicketExwUpdate());
                moTextExwUpdateNote.setVisible(isFormForTicketExwUpdate());

                // prepare registry edition:

                jtfRegistryKey.setText(SLibUtils.textKey(moRegistry.getPrimaryKey()));
            }

            moKeyScale.setValue(new int[] { moRegistry.getFkScaleId() });
            moBoolTared.setValue(moRegistry.isTared());
            moTextTicket.setValue(moRegistry.getNumber());

            moKeyProducer.setValue(new int[] { moRegistry.getFkProducerId() });
            itemStateKeyProducer();

            moKeyItem.setValue(new int[] { moRegistry.getFkItemId() });
            itemStateKeyItem();

            if (moRegistry.getFkInputSourceId() == SModSysConsts.SU_INP_SRC_NA) {
                moKeyInputSource.resetField();
            }
            else {
                moKeyInputSource.setValue(new int[] { moRegistry.getFkInputSourceId() });
            }

            moKeyRegion.setValue(new int[] { moRegistry.getFkRegionId_n()} );

            moTextPlates.setValue(moRegistry.getPlate());
            moTextPlatesCage.setValue(moRegistry.getPlateCage());
            moTextDriver.setValue(moRegistry.getDriver());

            moDecWeightSource.setValue(moRegistry.getWeightSource());
            moBoolWeightSourceAvailable.setValue(moRegistry.isWeightSourceAvailable() || moRegistry.getWeightSource() != 0);
            moDecWeightDestinyArrival.setValue(moRegistry.getWeightDestinyArrival());
            moDecWeightDestinyDeparture.setValue(moRegistry.getWeightDestinyDeparture());
            moDatetimeArrival.setValue(moRegistry.getDatetimeArrival());
            moDatetimeDeparture.setValue(moRegistry.getDatetimeDeparture());
            moTextScaleOperatorArrival.setValue(moRegistry.getScaleOperatorArrival());
            moTextScaleOperatorDeparture.setValue(moRegistry.getScaleOperatorDeparture());
            moDecPackingFullQuantityArrival.setValue(moRegistry.getPackingFullQuantityArrival());
            moDecPackingEmptyQuantityArrival.setValue(moRegistry.getPackingEmptyQuantityArrival());
            moDecPackingFullQuantityDeparture.setValue(moRegistry.getPackingFullQuantityDeparture());
            moDecPackingEmptyQuantityDeparture.setValue(moRegistry.getPackingEmptyQuantityDeparture());
            
            int[] key = moRegistry.getOpCalendarMonthKey();
            jtfOpCalendarMonth.setText(key == null ? "" : key[1] + "-" + SLibUtils.DecimalFormatCalendarMonth.format(key[2])); // yyyy-mm

            mbIsRevImport1 = moRegistry.isRevueltaImport1();
            mbIsRevImport2 = moRegistry.isRevueltaImport2();

            msCommentsArrival = moRegistry.getScaleCommentsArrival();
            msCommentsDeparture = moRegistry.getScaleCommentsDeparture();

            if (moRegistry.getChildTicketNotes().size() > 0) {
                moTextNote.setValue(moRegistry.getChildTicketNotes().get(0).getNote());
            }
            else {
                moTextNote.setValue("");
            }

            moKeyTicketOrigin.setValue(new int[] { moRegistry.getFkTicketOriginId() });

            if (moRegistry.getFkExwFacilityOriginId() != SModSysConsts.MU_EXW_FAC_NA) {
                moKeyExwFacilityOrigin.setValue(new int[] { moRegistry.getFkExwFacilityOriginId() });
            }
            else {
                moKeyExwFacilityOrigin.resetField();
            }

            moKeyTicketDestination.setValue(new int[] { moRegistry.getFkTicketDestinationId() });

            if (moRegistry.getFkExwFacilityDestinationId() != SModSysConsts.MU_EXW_FAC_NA) {
                moKeyExwFacilityDestination.setValue(new int[] { moRegistry.getFkExwFacilityDestinationId() });
            }
            else {
                moKeyExwFacilityDestination.resetField();
            }

            moTextExwUpdateNote.setValue(""); // field allways cleared for eventual input

            bgFreightType.clearSelection();
            moRadFreightFreight.setSelected(moRegistry.getFkFreightOriginId_n() != 0);
            moRadFreightDependent.setSelected(moRegistry.getFkFreightTicketId_n() != 0);
            moKeyFreightOrigin.setValue(new int[] { moRegistry.getFkFreightOriginId_n() });
            moKeyFreightTicket.setValue(new int[] { moRegistry.getFkFreightTicketId_n() });

            setFormEditable(true);

            if (moRegistry.isRegistryNew()) {
                if (moKeyScale.getItemCount() == 2) {
                    moKeyScale.setSelectedIndex(1);
                }
            }
            else {

            }

            computeWeightAverage();

            enableFields();

            addAllListeners();
        }
        catch (Exception e) {
            SLibUtils.showException(this, e);
        }
        finally {
            mbSettingForm = false;
        }
    }

    @Override
    public SDbRegistry getRegistry() throws Exception {
        SDbRegistry registry; // either SDbTicket or SDbTicketExwUpdate
        
        if (isFormForTicketExwUpdate()) {
            // updating ticket external warehouses:
            
            SDbTicketExwUpdate update = new SDbTicketExwUpdate();
            
            update.setPkTicketId(moRegistry.getPkTicketId());
            //update.setPkUpdateId(...);
            
            update.setNote(moTextExwUpdateNote.getValue());
            
            update.setFkOldTicketOriginId(moRegistry.getFkTicketOriginId());
            update.setFkOldTicketDestinationId(moRegistry.getFkTicketDestinationId());
            update.setFkOldExwFacilityOriginId(moRegistry.getFkExwFacilityOriginId());
            update.setFkOldExwFacilityDestinationId(moRegistry.getFkExwFacilityDestinationId());
            
            update.setFkNewTicketOriginId(moKeyTicketOrigin.getValue()[0]);
            update.setFkNewTicketDestinationId(moKeyTicketDestination.getValue()[0]);
            update.setFkNewExwFacilityOriginId(moKeyExwFacilityOrigin.getSelectedIndex() <= 0 ? SModSysConsts.MU_EXW_FAC_NA : moKeyExwFacilityOrigin.getValue()[0]);
            update.setFkNewExwFacilityDestinationId(moKeyExwFacilityDestination.getSelectedIndex() <= 0 ? SModSysConsts.MU_EXW_FAC_NA : moKeyExwFacilityDestination.getValue()[0]);
            
            //update.setFkUserId(...);
            //update.setTsUser(...);
            
            registry = update;
        }
        else {
            // creating or editing ticket:
            
            SDbTicket ticket = moRegistry.clone();

            if (ticket.isRegistryNew()) {
                ticket.setFkScaleId(moKeyScale.getValue()[0]);
                ticket.setFkTicketStatusId(SModSysConsts.SS_TIC_ST_SCA); // reinforce ticket initial status!
            }

            ticket.setNumber(moTextTicket.getValue());
            ticket.setDate(moDatetimeArrival.getValue());
            //ticket.setQuantity(...); // seemingly unused
            ticket.setPlate(moTextPlates.getValue());
            ticket.setPlateCage(moTextPlatesCage.getValue());
            ticket.setDriver(moTextDriver.getValue());
            ticket.setDatetimeArrival(moDatetimeArrival.getValue());
            ticket.setDatetimeDeparture(moRegistry.isRegistryNew() ? moDatetimeArrival.getValue() : moDatetimeDeparture.getValue());

            boolean tared = isFormForTicketTare() || moRegistry.isTared();

            ticket.setWeightSource(moDecWeightSource.getValue());
            ticket.setWeightDestinyArrival(moDecWeightDestinyArrival.getValue());
            ticket.setWeightDestinyDeparture(tared ? moDecWeightDestinyDeparture.getValue() : 0);
            ticket.setScaleOperatorArrival(moTextScaleOperatorArrival.getValue());
            ticket.setScaleOperatorDeparture(moTextScaleOperatorDeparture.getValue());
            ticket.setScaleCommentsArrival(msCommentsArrival == null ? "" : msCommentsArrival);
            ticket.setScaleCommentsDeparture(msCommentsDeparture == null ? "" : msCommentsDeparture);

            ticket.setPackingFullQuantityArrival(moDecPackingFullQuantityArrival.getValue());
            ticket.setPackingEmptyQuantityArrival(moDecPackingEmptyQuantityArrival.getValue());
            ticket.setPackingFullQuantityDeparture(moDecPackingFullQuantityDeparture.getValue());
            ticket.setPackingEmptyQuantityDeparture(moDecPackingEmptyQuantityDeparture.getValue());

            //ticket.setWeightDestinyGross_r(...);
            //ticket.setWeightDestinyNet_r(...);
            //ticket.setSystemPenaltyPercentage(...);
            //ticket.setSystemWeightPayment(...);
            //ticket.setSystemPricePerTon(...);
            //ticket.setSystemPayment_r(...);
            //ticket.setSystemFreight(...);
            //ticket.setSystemTotal_r(...);
            //ticket.setUserPenaltyPercentage(...);
            //ticket.setUserWeightPayment(...);
            //ticket.setUserPricePerTon(...);
            //ticket.setUserPayment_r(...);
            //ticket.setUserFreight(...);
            //ticket.setUserTotal_r(...);
            //ticket.setDpsSupplyDate_n(...);
            ticket.setRevueltaImport1(mbIsRevImport1);
            ticket.setRevueltaImport2(mbIsRevImport2);
            ticket.setWeightSourceAvailable(moBoolWeightSourceAvailable.getValue());
            ticket.setMfgOutsourcing(false);
            ticket.setTared(tared);
            ticket.setPayed(false);
            ticket.setAssorted(false);
            ticket.setPacking(mbIsPacking);
            ticket.setLaboratory(mbIsLaboratory);
            ticket.setDpsSupply(false);
            //ticket.setDeleted(...);
            //ticket.setSystem(...);
            //ticket.setFkScaleId(...); // value already set!
            //ticket.setFkTicketStatusId(...); // value already set!
            ticket.setFkSeasonId_n(mnSeasonId);
            ticket.setFkRegionId_n(moKeyRegion.getSelectedIndex() <= 0 ? 0 : moKeyRegion.getValue()[0]);
            ticket.setFkItemId(moKeyItem.getValue()[0]);
            ticket.setFkUnitId(moKeyItem.getSelectedItem().getForeignKey()[0]);
            ticket.setFkProducerId(moKeyProducer.getValue()[0]);
            ticket.setFkInputSourceId(moKeyInputSource.getSelectedIndex() <= 0 ? SModSysConsts.SU_INP_SRC_NA : moKeyInputSource.getValue()[0]);
            //ticket.setFkLaboratoryId_n(...); // value updated outside the scrope of this form!
            ticket.setFkTicketOriginId(moKeyTicketOrigin.getValue()[0]);
            ticket.setFkTicketDestinationId(moKeyTicketDestination.getValue()[0]);
            ticket.setFkExwFacilityOriginId(moKeyExwFacilityOrigin.getSelectedIndex() <= 0 ? SModSysConsts.MU_EXW_FAC_NA : moKeyExwFacilityOrigin.getValue()[0]);
            ticket.setFkExwFacilityDestinationId(moKeyExwFacilityDestination.getSelectedIndex() <= 0 ? SModSysConsts.MU_EXW_FAC_NA : moKeyExwFacilityDestination.getValue()[0]);
            //ticket.setFkExternalDpsYearId_n(...);
            //ticket.setFkExternalDpsDocId_n(...);
            //ticket.setFkExternalDpsEntryId_n(...);
            //ticket.setFkUserTaredId(miClient.getSession().getUser().getPkUserId());
            //ticket.setFkUserPayedId(...);
            //ticket.setFkUserAssortedId(...);

            ticket.setAuxRequirePriceComputation(!mbIsLaboratory && isFormForTicketTare());

            if (isFormForTicketTare()) {
                if (moItem.isAutoMailNotification()) {
                    ticket.setAuxSendMailOnSaveForItems(true);
                    ticket.setAuxMailRecipientsForItems(moItem.getAutoMailNotificationBoxes());
                }

                if (moProducer.isAutoMailNotification()) {
                    ticket.setAuxSendMailOnSaveForProducer(true);
                    ticket.setAuxMailRecipientsForProducer(moProducer.getAutoMailNotificationBoxes());
                }
            }

            ticket.setAuxMoveNextOnSend(mbSaveSendCalled);

            ticket.getChildTicketNotes().clear();
            if (!moTextNote.getValue().isEmpty()) {
                SDbTicketNote ticketNote = new SDbTicketNote();
                ticketNote.setNote(moTextNote.getValue());
                ticket.getChildTicketNotes().add(ticketNote);
            }

            if (mbIsFreightRequired) {
                ticket.setRequiredFreight(SDbTicket.REQ_FRT_YES);
                
                if (moRadFreightFreight.isSelected()) {
                    ticket.setFreightTicketType(SDbTicket.FRT_TIC_TP_FRT);
                    ticket.setFkFreightOriginId_n(moKeyFreightOrigin.getValue()[0]);
                    ticket.setFkFreightTicketId_n(0);
                }
                else {
                    ticket.setFreightTicketType(SDbTicket.FRT_TIC_TP_DEP);
                    ticket.setFkFreightOriginId_n(0);
                    ticket.setFkFreightTicketId_n(moKeyFreightTicket.getValue()[0]);
                }
            }
            else {
                ticket.setRequiredFreight(SDbTicket.REQ_FRT_NO);
                
                ticket.setFreightTicketType("");
                ticket.setFkFreightOriginId_n(0);
                ticket.setFkFreightTicketId_n(0);
            }

            registry = ticket;
        }
        
        return registry;
    }

    @Override
    public SGuiValidation validateForm() {
        SGuiValidation validation = moFields.validateFields();
        
        if (validation.isValid()) {
            if (!SGuiClientUtils.isPeriodOpened(miClient.getSession(), moDatetimeArrival.getValue())) {
                int[] date = SLibTimeUtils.digestMonth(moDatetimeArrival.getValue());
                String[] months = SLibTimeUtils.createMonthsOfYearStd(Calendar.LONG);
                
                validation.setMessage("El período actual, " + months[date[1] - 1] + " " + date[0] + ", está cerrado.");
                validation.setComponent(((JSpinner.DefaultEditor) moDatetimeArrival.getComponent().getEditor()).getTextField());
            }
            else {
                if (isFormForTicketExwUpdate()) {
                    if (moRegistry.isRegistryNew()) {
                        validation.setMessage("No se puede modificar un boleto que es nuevo.");
                    }
                }
                else if (isFormForTicketTare()) {
                    if (moRegistry.isRegistryNew()) {
                        validation.setMessage("No se puede tarar un boleto que es nuevo.");
                    }
                    else if (isRequiredInputSource() && moKeyInputSource.getSelectedIndex() <= 0) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moKeyInputSource.getFieldName() + "'." +
                                (moKeyInputSource.isEnabled() ? "" : "Favor de modificar este registro desde la vista \"Boletos báscula\"."));
                        if (moKeyInputSource.isEnabled()) {
                            validation.setComponent(moKeyInputSource);
                        }
                    }
                    
                    if (validation.isValid() && !mbIsRevImport2) {
                        validation = SGuiUtils.validateDateRange(moDatetimeArrival, moDatetimeDeparture);
                        
                        if (!validation.isValid()) {
                            if (moDatetimeArrival.isEditable()) {
                                validation.setComponent(((JSpinner.DefaultEditor) moDatetimeArrival.getComponent().getEditor()).getTextField());
                            }
                            else if (moDatetimeDeparture.isEditable()) {
                                validation.setComponent(((JSpinner.DefaultEditor) moDatetimeDeparture.getComponent().getEditor()).getTextField());
                            }
                        }
                    }  
                }
                
                if (validation.isValid()) {
                    if (mbIsPacking) {
                        computeWeightAverage();
                        
                        if (moDecPackingFullQuantityArrival.getValue() == 0 &&
                                miClient.showMsgBoxConfirm("No se ha especificado un valor para el campo '" + moDecPackingFullQuantityArrival.getFieldName() + "'."
                                        + "\n" + SGuiConsts.MSG_CNF_CONT_OMIT_VAL) != JOptionPane.YES_OPTION) {
                            validation.setMessage(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moDecPackingFullQuantityArrival.getFieldName() + "'.");
                            validation.setComponent(moDecPackingFullQuantityArrival.isEditable() ? moDecPackingFullQuantityArrival : jbEditPackingFullQuantityArrival);
                        }
                        else if (isFormForTicketTare() && moDecPackingEmptyQuantityDeparture.isEditable() && moDecPackingEmptyQuantityDeparture.getValue() == 0 &&
                                miClient.showMsgBoxConfirm("No se ha especificado un valor para el campo '" + moDecPackingEmptyQuantityDeparture.getFieldName() + "'."
                                        + "\n" + SGuiConsts.MSG_CNF_CONT_OMIT_VAL) != JOptionPane.YES_OPTION) {
                            validation.setMessage(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + moDecPackingEmptyQuantityDeparture.getFieldName() + "'.");
                            validation.setComponent(moDecPackingEmptyQuantityDeparture);
                        }
                        else {
                            // confirm a negative weight:
                            SDbTicket dummy = new SDbTicket();
                            dummy.setPackingFullQuantityArrival(moDecPackingFullQuantityArrival.getValue());
                            dummy.setPackingEmptyQuantityArrival(moDecPackingEmptyQuantityArrival.getValue());
                            dummy.setPackingFullQuantityDeparture(moDecPackingFullQuantityDeparture.getValue());
                            dummy.setPackingEmptyQuantityDeparture(moDecPackingEmptyQuantityDeparture.getValue());
                            dummy.setWeightDestinyArrival(moDecWeightDestinyArrival.getValue());
                            dummy.setWeightDestinyDeparture(moDecWeightDestinyDeparture.getValue());
                            dummy.setFkItemId(moKeyItem.getValue()[0]);

                            try {
                                dummy.computeWeight(miClient.getSession(), false);
                                if (dummy.getWeightDestinyNet_r() < 0) {
                                    if (miClient.showMsgBoxConfirm("¡El peso neto del ticket es negativo: " + SLibUtils.getDecimalFormatQuantity().format(dummy.getWeightDestinyNet_r()) + "!"
                                            + "\n" + SGuiConsts.MSG_CNF_CONT_OMIT_VAL) != JOptionPane.YES_OPTION) {
                                        validation.setMessage("¡Revisar los pesos de entrada y salida!");
                                    }
                                }
                            }
                            catch (Exception e) {
                                SLibUtils.showException(this, e);
                            }
                        }
                    }
                }
                
                if (validation.isValid()) {
                    if (moKeyTicketOrigin.getValue()[0] == SModSysConsts.SU_TIC_ORIG_NA) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyTicketOrigin.getFieldName() + "'.");
                        validation.setComponent(moKeyTicketOrigin);
                    }
                    else if (moKeyTicketOrigin.getValue()[0] == SModSysConsts.SU_TIC_ORIG_EXW && moKeyExwFacilityOrigin.getSelectedIndex() > 0 && moKeyExwFacilityOrigin.getValue()[0] == SModSysConsts.MU_EXW_FAC_NA) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyExwFacilityOrigin.getFieldName() + "'.");
                        validation.setComponent(moKeyExwFacilityOrigin);
                    }
                    else if (moKeyTicketDestination.getValue()[0] == SModSysConsts.SU_TIC_DEST_NA) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyTicketDestination.getFieldName() + "'.");
                        validation.setComponent(moKeyTicketDestination);
                    }
                    else if (moKeyTicketDestination.getValue()[0] == SModSysConsts.SU_TIC_DEST_EXW && moKeyExwFacilityDestination.getSelectedIndex() > 0 && moKeyExwFacilityDestination.getValue()[0] == SModSysConsts.MU_EXW_FAC_NA) {
                        validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyExwFacilityDestination.getFieldName() + "'.");
                        validation.setComponent(moKeyExwFacilityDestination);
                    }
                    else if (moKeyTicketOrigin.getValue()[0] == SModSysConsts.SU_TIC_ORIG_EXW && moKeyTicketDestination.getValue()[0] == SModSysConsts.SU_TIC_DEST_EXW &&
                            miClient.showMsgBoxConfirm("El valor de los campos '" + moKeyTicketOrigin.getFieldName() + "' y '" + moKeyTicketDestination.getFieldName() + "' no debería ser el mismo.\n" + SGuiConsts.MSG_CNF_CONT_OMIT_VAL) != JOptionPane.YES_OPTION) {
                        validation.setMessage("Se debe especificar un valor distinto para los campos '" + moKeyTicketOrigin.getFieldName() + "' y/o '" + moKeyTicketDestination.getFieldName() + "'.");
                        validation.setComponent(moKeyTicketOrigin);
                    }
                    else if (moKeyTicketOrigin.getValue()[0] == SModSysConsts.SU_TIC_ORIG_EXW && moKeyTicketDestination.getValue()[0] == SModSysConsts.SU_TIC_DEST_EXW && moKeyExwFacilityOrigin.getValue()[0] == moKeyExwFacilityDestination.getValue()[0] &&
                            miClient.showMsgBoxConfirm("El valor de los campos '" + moKeyExwFacilityOrigin.getFieldName() + "' y '" + moKeyExwFacilityDestination.getFieldName() + "' no debería ser el mismo.\n" + SGuiConsts.MSG_CNF_CONT_OMIT_VAL) != JOptionPane.YES_OPTION) {
                        validation.setMessage("Se debe especificar un valor distinto para los campos '" + moKeyExwFacilityOrigin.getFieldName() + "' y/o '" + moKeyExwFacilityDestination.getFieldName() + "'.");
                        validation.setComponent(moKeyExwFacilityOrigin);
                    }
                    else if (mbIsFreightRequired && !isFormForTicketExwUpdate()) {
                        if (bgFreightType.getSelection() == null) {
                            validation.setMessage(SGuiConsts.ERR_MSG_FIELD_REQ + "'" + SGuiUtils.getLabelName(jlFreightControl) + "'.");
                            validation.setComponent(moRadFreightFreight);
                        }
                        else if (moRadFreightFreight.isSelected() && moKeyFreightOrigin.getValue()[0] == SModSysConsts.SU_FREIGHT_ORIG_NA) {
                            validation.setMessage(SGuiConsts.ERR_MSG_FIELD_DIF + "'" + moKeyFreightOrigin.getFieldName() + "'.");
                            validation.setComponent(moKeyFreightOrigin);
                        }
                    }
                }
            }
        }

        return validation;
    }

    @Override
    public void actionPerformed(ActionEvent e) {
        if (e.getSource() instanceof JButton) {
            JButton button = (JButton) e.getSource();

            if (button == jbImportTicket) {
                actionImportTicket();
            }
            else if (button == jbCleanTicket) {
                actionCleanTicket();
            }
            else if (button == jbSetDefaultInputSource) {
                actionSetDefaultInputSource();
            }
            else if (button == jbImportTicketTare) {
                actionImportTicketTare();
            }
            else if (button == jbCleanTicketTare) {
                actionCleanTicketTare();
            }
            else if (button == jbSaveSend) {
                actionSaveSend();
            }
            else if (button == jbEditPackingFullQuantityArrival) {
                actionEditPackingFullQuantityArrival();
            }
            else if (button == jbEditPackingEmptyQuantityArrival) {
                actionEditPackingEmptyQuantityArrival();
            }
        }
        else if (e.getSource() instanceof JRadioButton) {
            JRadioButton button = (JRadioButton) e.getSource();
            
            if (button == moRadFreightFreight) {
                actionRadEnableFreight();
            }
            else if (button == moRadFreightDependent) {
                actionRadEnableFreight();
            }
        }
    }

    @Override
    public void itemStateChanged(ItemEvent e) {
        if (!mbSettingForm && !mbProcessingProducer) {
            if (e.getSource() instanceof JComboBox && e.getStateChange() == ItemEvent.SELECTED) {
                JComboBox comboBox = (JComboBox)  e.getSource();

                if (comboBox == moKeyProducer) {
                    itemStateKeyProducer();
                }
                else if (comboBox == moKeyItem) {
                    itemStateKeyItem();
                }
                else if (comboBox == moKeyTicketOrigin) {
                    itemStateKeyTicketOrigin();
                }
                else if (comboBox == moKeyTicketDestination) {
                    itemStateKeyTicketDestination();
                }
            }
            else if (e.getSource() instanceof JCheckBox) {
                JCheckBox checkBox = (JCheckBox)  e.getSource();

                if (checkBox == moBoolWeightSourceAvailable) {
                    itemStateWeightSourceAvailable();
                }
            }
        }
    }

    @Override
    public void focusGained(FocusEvent e) {

    }

    @Override
    public void focusLost(FocusEvent e) {
        if (e.getSource() instanceof javax.swing.JTextField) {
            JTextField textField = (JTextField) e.getSource();

            if (textField == moDecWeightSource.getComponent() ||
                textField == moDecWeightDestinyArrival.getComponent() ||
                textField == moDecWeightDestinyDeparture.getComponent() ||
                textField == moDecPackingFullQuantityArrival.getComponent() ||
                textField == moDecPackingEmptyQuantityArrival.getComponent() ||
                textField == moDecPackingFullQuantityDeparture.getComponent() ||
                textField == moDecPackingEmptyQuantityDeparture.getComponent()) {

                computeWeightAverage();
            }
        }
    }

    @Override
    public void stateChanged(ChangeEvent e) {
        if (e.getSource() instanceof javax.swing.JSpinner) {
            JSpinner spinner = (JSpinner) e.getSource();
            
            if (spinner == moDatetimeArrival.getComponent()) {
                readRegion();
                enableFields();
            }
        }
    }
}
